## Rythmanalyse fonction v.4.4

Rythmanalyse <- function (nomfichier){ # type : "2014.02.16.MT.Doom.s1.zip"
  
  source("~/Documents/Projets R/Rythmanalyse/Script R/ImportZip.1.R")
  source("~/Documents/Projets R/Rythmanalyse/Script R/AnalyseSouris.1.R")
  source("~/Documents/Projets R/Rythmanalyse/Script R/AnalyseClavier.1.1.R")
  source("~/Documents/Projets R/Rythmanalyse/Script R/AnalysePad.1.1.R")
  
  ImportZip (nomfichier)

  titre <- substr (nomfichier,15,nchar(nomfichier)-4)
  date <- substr (nomfichier,1,10)
  usr <- substr (nomfichier,12,13)
  Rez <- cbind (nomfichier,date,usr,titre) ## Attention ? tout sortir au meme format pour traitement en masse

  if (exists("d.M", environment()) & exists ("d.K", environment())) {
    d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
    d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
    densK <- density (d.Kdown$K.TEMPS, bw =3)
    densM <- density (d.Mc$M.TEMPS, bw =3)
      if (max(densK$y) > max(densM$y)) {
        png (filename = paste (date,".",usr,".",titre,".KM10",".png", sep =""), width = 1500, height = 700)
        plot (density(d.Kdown$K.TEMPS, bw=10), lwd=2, col = "red", xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Appuis clavier/souris (val. absolue, bw = 10)"))
        points (density(d.Mc$M.TEMPS, bw=10), type ="l", lwd=2, lty = 2, col = "blue", main ="", xlab ="", ylab="")
        legend("topright", inset=.01, c("Clavier","Souris"),
           lwd=c(2,2), lty=c(1, 2), col=c("red", "blue"))
        dev.off()
      }
      else {
        png (filename = paste (date,".",usr,".",titre,".MK10",".png", sep =""), width = 1500, height = 700)
        plot (density(d.Mc$M.TEMPS, bw=10), lwd=2, col = "blue", lty= 2, xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Appuis clavier/souris (val. absolue, bw = 10)"))
        points (density(d.Kdown$K.TEMPS, bw=10), type ="l", lwd=2, col = "red", main ="", xlab ="", ylab="")
        legend("topright", inset=.01, c("Souris","Clavier"),
           lwd=c(2,2), lty=c(2, 1), col=c("blue", "red"))
        dev.off()
      }
  }

  if (exists("d.K", environment())) {
    Rez <- cbind (Rez,AnalyseClavier(d.K))
    d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
    png (filename = paste (date,".",usr,".",titre,".K10",".png", sep =""), width = 1500, height = 700)
    plot (density(d.Kdown$K.TEMPS, bw=10), xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Densité des appuis clavier (bw=10)"))
    dev.off()
    rm (d.K,envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(K.DuM=NA,K.NbTouches=NA,K.NbTouchesFreq=NA,
                          K.NbAppuis=NA,K.NbAppuisS=NA,
                          K.TpMoyEntreAppuis=NA,K.TpSDEntreAppuis=NA,
                          K.TpMoyAppui=NA,K.TpSDAppui=NA,
                          K.ToucheFreq=NA,K.PropFreq=NA,
                          K.TpMoyAppuiFreq=NA,K.TpSDAppuiFreq=NA)
    Rez <- cbind (Rez,resultats)
  }

  if (exists("d.M", environment())) {
    Rez <- cbind (Rez,AnalyseSouris(d.M))
    d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
    png (filename = paste (date,".",usr,".",titre,".M10",".png", sep =""), width = 1500, height = 700)
    plot (density(d.Mc$M.TEMPS, bw=10), xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Densité des appuis souris (bw=10)"))
    dev.off()                      
    rm (d.M, envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(M.DuM=NA,M.NbClics=NA,M.NbCliclsS=NA,
                          M.LR=NA,M.TpMoyEntreAppuis=NA,M.TpSDEntreAppuis=NA,M.Vit=NA)
    Rez <- cbind (Rez,resultats)
  }

  if (exists("d.P", environment())) {
    Rez <- cbind (Rez,AnalysePad(d.P))
    #png (filename = paste (date,".",usr,".",titre,".P10",".png", sep =""), width = 800, height = 500)
    #plot (density(PadRythmn$timecode, bw=10), xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Densité des appuis pad (bw=10)"))
    #dev.off()
    #rm (PadRythmn, d.P, envir = .GlobalEnv)
    rm (d.P, envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(P.DuM=NA,P.NbTouches=NA,P.NbTouchesFreq=NA,
                          P.NbAppuis=NA,P.NbAppuisS=NA,
                          P.TpMoyEntreAppuis=NA,P.TpSDEntreAppuis=NA, 
                          P.TpMoyAppui=NA,P.TpSDAppui=NA,
                          P.ToucheFreq=NA,P.PropFreq=NA,
                          P.TpMoyEntreAppuisFreq=NA,P.TpSDEntreAppuisFreq=NA, 
                          P.TpMoyAppuiFreq=NA,P.TpSDAppuiFreq=NA,
                          P.Vit=NA,P.VitG=NA,P.VitD=NA)
    Rez <- cbind (Rez,resultats)
  }

  write.csv(Rez, file = paste(date,".",usr,".",titre,".ok.csv", sep=""))
  return (Rez)
}