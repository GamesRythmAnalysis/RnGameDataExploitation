# SORTIES GRAPHIQUES
# GRAPHIQUES CLAVIER SEUL

graphiques.clavier <- function (K.NbTouchesFreq,touchesfreq,d.Kdown,d.K,K.DuM,infobaz) {
  
  
  ggplot(data = d.Kdown, aes (K.TEMPS)) +
    geom_density (kernel = "gaussian", bw = 10, 
                 linetype = 1, size = 2, color ="red") +
    xlab ("Temps (s)") +
    ylab ("Appuis") +
    ggtitle (label = "Frequence des appuis clavier",
             subtitle = infobaz) +
    theme_classic()
  ggsave(filename = paste (infobaz,".K10",".png", sep =""), width = 15, height = 7)

  # Decomposition densite par touches (sur touches freq.)
  # Pas plus de 9 touches freq. pour plage couleur
  if (K.NbTouchesFreq > 1) {
    
    ifelse (K.NbTouchesFreq < 10, 
            nomtouchesfreq <- rownames (touchesfreq)[1:K.NbTouchesFreq],
            nomtouchesfreq <- rownames (touchesfreq)[1:9])
    timingappui2 <- subset(d.Kdown, K.TOUCHE %in% nomtouchesfreq)
    
    # choisir des seuils de densite pour le binwidth de geom_area
    # le choix de K.DuM a l'air d'un bon compromis
    
    ggplot(timingappui2, aes (K.TEMPS, fill = K.TOUCHE))+
      geom_area (stat="bin", binwidth = K.DuM*3, position = "stack", linetype = 1, size = 0.8, colour ="black") +
      xlab ("Temps (s)") +
      ylab ("Appuis") +
      ggtitle (label = "Frequence des appuis clavier (touches frequentes) | binwidth variable",
               subtitle = infobaz) +
      scale_fill_brewer("Touche", palette="Set1")+
      theme_classic()
    ggsave(filename = paste (infobaz,".TCHVAR",".png", sep =""), width = 15, height = 7)
    
    # Visualisations : densite relative des appuis (touches les plus frequentes) sur la duree de la session
    
    
    viztouches <- as.data.frame(touchesfreq) 
    names(viztouches) <- c ("touche", "freq")
    viztouches <- subset(viztouches, touche %in% nomtouchesfreq)
    
    ggplot (data = viztouches, aes (area = freq, fill = touche, label = touche))+
      geom_treemap(linetype = 1, colour ="white", size =3) +
      scale_fill_brewer(palette = "Set1") +
      ggtitle (label = "Frequence des appuis clavier (touches frequentes)",
               subtitle = infobaz) +
      theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
      geom_treemap_text(grow = TRUE, reflow = TRUE) +
      guides (fill = FALSE)
    ggsave(filename = paste (infobaz,".TCHFREQ",".png", sep =""), width = 15, height = 15)
    
    keyboard_rythm <- lapply(levels(d.K$K.TOUCHE),GetKeyRythm)
    keyboard_rythm <- do.call("rbind",keyboard_rythm)
    
    durtouches <- keyboard_rythm %>%
      group_by(touche) %>%
      summarise(dureemoy = mean(duration)) %>%
      filter (touche %in% nomtouchesfreq)
    
    ggplot (data = durtouches, aes (area = dureemoy, fill = touche, label = touche))+
      geom_treemap(linetype = 1, colour ="white", size =3) +
      scale_fill_brewer(palette = "Set1") +
      ggtitle (label = "Duree moyenne d'appui sur les touches les plus frequentes",
               subtitle = infobaz) +
      theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
      geom_treemap_text(grow = TRUE, reflow = TRUE) +
      guides (fill = FALSE)
    ggsave(filename = paste (infobaz,".TCHDUR",".png", sep =""), width = 15, height = 15)
    
    totaldur <- keyboard_rythm %>%
      group_by(touche) %>%
      summarise(dureemoy = sum(duration)) %>%
      filter (touche %in% nomtouchesfreq)
    
    ggplot (data = totaldur, aes (area = dureemoy, fill = touche, label = touche))+
      geom_treemap(linetype = 1, colour ="white", size =3) +
      scale_fill_brewer(palette = "Set1") +
      ggtitle (label = "Duree totale d'appui sur les touches les plus frequentes",
               subtitle = infobaz) +
      theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
      geom_treemap_text(grow = TRUE, reflow = TRUE) +
      guides (fill = FALSE)
    ggsave(filename = paste (infobaz,".TCHDURTOT",".png", sep =""), width = 15, height = 15)
  }
}

  
