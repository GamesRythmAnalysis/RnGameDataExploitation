# Analyse Souris
# Fonction pour analyse de la souris Rythmanalyse

AnalyseSouris <- function (d.M,infobaz) {
  # Nombre clics (distinguer droit et gauche) / repartion en % gauche
  d.McL <- subset (d.M, M.EVENEMENT == "mouse 1 down")
  d.McR <- subset (d.M, M.EVENEMENT == "mouse 2 down")
  d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
  M.NbClics <- length (d.Mc$M.TEMPS)
  M.LR <- length (d.McL$M.TEMPS)/length (d.Mc$M.TEMPS) * 100 # pourcentage clic gauche
  # Duree secondes, minutes activite souris
  M.DuS <- max (d.M$M.TEMPS) - min (d.M$M.TEMPS)
  M.DuM <- M.DuS / 60
  # Nombre clics par seconde
  M.NbCliclsS <- M.NbClics / M.DuS
  # Temps entre deux clics et ecart-type
  M.TpEntreAppuis <- d.Mc$M.TEMPS[2:length(d.Mc$M.TEMPS)]-d.Mc$M.TEMPS[1:length(d.Mc$M.TEMPS)-1]
  M.TpMoyEntreAppuis <- mean ( M.TpEntreAppuis)
  M.TpSDEntreAppuis <- sd (M.TpEntreAppuis)
  # On détermine s'il y a recentrage
  cond1 <- fivenum(d.M$M.XPOS)[4]-fivenum(d.M$M.XPOS)[2]
  cond2 <- fivenum(d.M$M.YPOS)[4]-fivenum(d.M$M.YPOS)[2]
  if (cond1 > 20 & cond2 > 20) { # On teste si donnees mouvement souris ne sont pas bugges
    DifX <- (d.M$M.XPOS[2:length(d.M$M.XPOS)] - d.M$M.XPOS[1:length(d.M$M.XPOS)-1])
    DifY <- d.M$M.YPOS[2:length(d.M$M.YPOS)] - d.M$M.YPOS[1:length(d.M$M.YPOS)-1]
    M.Vit <- sum (sqrt (DifX^2 +DifY^2)) / max (d.M$M.TEMPS)
    M.VitTrueXY <- TRUE
    
    d2sampl <- d.M[sample(nrow(d.M), (nrow(d.M)/10)), ]
    
    ggplot (d2sampl,aes (x=-M.XPOS, y=-M.YPOS)) +
      geom_point(colour ="lightblue", alpha =0.25) +
      stat_density2d(aes(alpha = ..level.., fill=..level..), bins = 15, geom = "polygon")+
      scale_alpha_continuous(guide = FALSE)+
      scale_fill_gradient(low = "green", high = "red") +
      geom_density2d (colour="black", bins = 15, alpha = 0.25) + 
      ggtitle(paste(infobaz,"\n","Mouvement Souris"))
    ggsave (file = paste (infobaz,".M.map",".png", sep =""),
            width = 150, height = 125, units = "mm")
    
  } else {
    # On sélectionne les valeurs situées autour de la médiane
    xCenter <- median (d.M$M.XPOS)
    yCenter <- median (d.M$M.YPOS)
    # Seuil arbitraire à 20, pas trouvé de méthode pour le déterminer
    # A partir de 20, vitesse reste constante
    # En dessous on la diminue ; artificiellement ?
    seuil <- 20
    d.M <- subset (d.M, d.M$M.XPOS < xCenter+seuil & d.M$M.XPOS > xCenter-seuil
                   & d.M$M.YPOS < yCenter+seuil & d.M$M.YPOS > yCenter-seuil)
    # On replace tout sur un point zéro ...
    # Qui n'est malheureusement jamais le vrai centre
    # Du fait de la dérive de la distribution
    ZXPOS <- d.M$M.XPOS - xCenter
    ZYPOS <- d.M$M.YPOS - yCenter
    # Les essais pour corriger la dérive 
    # en prenant en compte écart mean à median ont échoué
    TrueX <- numeric(nrow(d.M)+1)
    for (i in (1:length(ZXPOS))){
      TrueX [i+1] <- TrueX [i] + ZXPOS [i]
    }
    
    TrueY <- numeric(nrow(d.M)+1)
    for (i in (1:length(ZYPOS))){
       TrueY [i+1] <- TrueY [i] + ZYPOS [i]
    }
    
    DifX <- (TrueX[2:length(TrueX)] - TrueX[1:length(TrueX)-1])
    DifY <- TrueY[2:length(TrueY)] - TrueY[1:length(TrueY)-1]
    M.Vit <- sum (sqrt (DifX^2 +DifY^2)) / max (d.M$M.TEMPS)
    M.VitTrueXY <- FALSE
    
    dsample <- data.frame (TrueX,TrueY)
    dsample <- dsample[sample(nrow(dsample), (nrow(dsample)/10)), ]
    
    ggplot (dsample,aes (x=-TrueX, y=-TrueY)) +
      geom_point(colour ="lightblue", alpha =0.25) +
      stat_density2d(aes(alpha = ..level.., fill=..level..), bins = 15, geom = "polygon")+
      scale_alpha_continuous(guide = FALSE)+
      scale_fill_gradient(low = "green", high = "red") +
      geom_density2d (colour="black", bins = 15, alpha = 0.25) + 
      ggtitle(paste(infobaz,"\n","Mouvement Souris"))
    ggsave (file = paste (infobaz,".M.map",".png", sep =""),
            width = 150, height = 125, units = "mm")
    
  }
  
  #M.NbClics # Nombre total d'appuis
  #M.LR # Pourcentage de clics gauche
  #M.DuM # Duree activite souris en minutes
  #M.NbCliclsS # Clics par seconde
  #M.TpMoyEntreAppuis # Temps moyen entre deux appuis
  #M.TpSDEntreAppuis # Ecart type entre deux appuis
  #M.Vit # Moyenne des vitesses instantanées
  
  resultats <- data.frame(M.DuM,M.NbClics,M.NbCliclsS,
                          M.LR,M.TpMoyEntreAppuis,M.TpSDEntreAppuis,
                          M.Vit,M.VitTrueXY)
  return (resultats)
}