# Analyse Clavier
# Fonction pour analyse du clavier Rythmanalyse

GetKeyRythm <- function(key){
  ## Un data frame vide pour recevoir les r?sultats
  results <- data.frame("down.time"=numeric(),"duration"=numeric(),"touche"=factor())
  down <- NULL
  ## On est oblig? de passer par une boucle pour parser ligne par ligne
  for (i in 1:nrow(d.K)) {
    ## ignorer les lignes qui concernent une autre cl? que la notre
    if (d.K[i,"K.TOUCHE"] != key) next
    ## Pour la bonne cl?, si l'on rencontre un down, le stocker 
    ##(ainsi, si l'on rencontre deux down de suite, sans up entre les deux, 
    ##le premier sera effa?? et seul le second comptera)
    if (d.K$K.EVENEMENT[i] == "Key Down") {
      down <- d.K[i,]
      next
    }
    ## Si l'on rencontre un up
    if (d.K$K.EVENEMENT[i] == "Key Up") {
      ## v?rifier si l'on a bien eu un down pr?c?demment
      if (is.null(down)== FALSE) {
        ## Calculer la dur?e entre down et up
        duration <- d.K$K.TEMPS[i] - down$K.TEMPS
        down.time <- down$K.TEMPS
        ## cr?er une ligne de data frame avec nom de la cl?, d?but du down, temps du down
        ligne <- c(down.time,duration)
        ## la concat?ner avec les r?sultats pr?c?dents
        results <- rbind(results,ligne)
        ## vider le down (en cas de deux up cons?cutifs, au cas o?)
        down <- NULL}
      #if (is.null(down)== TRUE) { # Traiter erreur dans le cas o? on rencontre d'abord un Up (? n?gliger)
      else
      {
        duration <- NA
        down.time <- NA
        ligne <-c(down.time,duration)
        results <- rbind (results,ligne)
      }
    }
    
    ## ajouter une variable identifiant la cl? pour fusion avec les r?sultats sur les autres cl?
    results$touche <- key
    
  }
  names (results) <- c ("down.time","duration","touche")
  return(results)
}

AnalyseClavier <- function (d.K) { #possibilit? de repasser valfreq pour touches freq. en argument
  # Nombre appuis
  d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
  K.NbAppuis <- length (d.Kdown$K.EVENEMENT)
  # Dur?e secondes, dur?e minutes activit? clavier
  K.DuS <- max (d.K$K.TEMPS, na.rm = TRUE)
  K.DuM <- K.DuS / 60
  # Nombre d'appuis par seconde
  K.NbAppuisS <- K.NbAppuis / K.DuS
  # Nombre de touches utilis?es
  # sort(table(d.K$K.TOUCHE), decreasing = TRUE)
  K.NbTouches <- length(levels(d.K$K.TOUCHE))
  # Touches fr?quentes
  valfreq <- 0.01
  tabletouches <- sort(table(d.Kdown$K.TOUCHE),decreasing=TRUE)
  touchesfreq <- subset (tabletouches, tabletouches > K.NbAppuis * valfreq)
  K.NbTouchesFreq <- length (touchesfreq)
  
  # Temps entre appuis et ?cart-type
  K.TpEntreAppuis <- d.Kdown$K.TEMPS[2:length(d.Kdown$K.TEMPS)]-d.Kdown$K.TEMPS[1:length(d.Kdown$K.TEMPS)-1]
  K.TpMoyEntreAppuis <- mean (K.TpEntreAppuis)
  K.TpSDEntreAppuis <- sd (K.TpEntreAppuis)
  # Dur?e des appuis
  keyboard_rythm <- lapply(levels(d.K$K.TOUCHE),GetKeyRythm)
  keyboard_rythm <- do.call("rbind",keyboard_rythm)
  K.TpMoyAppui <- mean (keyboard_rythm$duration, na.rm = TRUE) # Temps moyen d'un appui
  K.TpSDAppui <- sd (keyboard_rythm$duration, na.rm = TRUE) # Ecart-type temps d'un appui
  
  mostfreq <- subset (keyboard_rythm, keyboard_rythm$touche == names (touchesfreq[1])) # On ne conserve que la touche la plus fréquente
  K.ToucheFreq <- mostfreq$touche[1]
  K.PropFreq <- (nrow (mostfreq)/K.NbAppuis)*100
  K.TpMoyAppuiFreq <- mean (mostfreq$duration, na.rm = TRUE) # Temps moyen d'un appui
  K.TpSDAppuiFreq <- sd (mostfreq$duration, na.rm = TRUE) # Ecart-type temps d'un appui
  
  #K.NbAppuis # Nombre total d'appuis
  #K.DuM # Duree en minute de l'activite clavier
  #K.NbAppuisS # Appuis par seconde
  #K.NbTouches # Nombre de touches utilisees
  #K.NbTouchesFreq # Nombre de touches frequemment utilis?es (enlever inf. ? valfreq 1%)
  #K.TpMoyEntreAppuis # Temps moyen entre appuis  
  #K.TpSDEntreAppuis # Ecart-type
  #K.TpMoyAppui # Duree moyenne d'un appui
  #K.TpSDAppui # Ecart-type duree d'un appui
  # K.TpMoyAppuiFreq # Durée moyenne d'un appui sur touche la plus fréquente
  # K.TpSDAppuiFreq # Ecart-type durée d'un appui sur touche la plus fréquente
  
  resultats <- data.frame(K.DuM,K.NbTouches,K.NbTouchesFreq,
                          K.NbAppuis,K.NbAppuisS,
                          K.TpMoyEntreAppuis,K.TpSDEntreAppuis,
                          K.TpMoyAppui,K.TpSDAppui,
                          K.ToucheFreq,K.PropFreq,
                          K.TpMoyAppuiFreq,K.TpSDAppuiFreq)
  return (resultats)
}