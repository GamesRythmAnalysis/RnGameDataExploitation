
#==#==#==#==#

# Fonction souris.decentrage : annule le rencentrage des mouvement de la souris par les jeux 

# Return : les nouvelles donnee de mouvement de souris avec les mouvements deplies

#==#==#==#==#

souris.decentrage <- function (donneesouris,infobaz) {
  
  # On slectionne les valeurs medianne
  xCenter <- median (d.M$M.XPOS)
  yCenter <- median (d.M$M.YPOS)
  
  # On suprime tout ce qui as ete capture hors du jeu avec un seuil arbitraire de 85%
  # qui marche assez bien pour les petite session et devrais aussi bien marcher sur les plus longues
  seuils <- seq(10,50,by=10)
  i<-1
  SUB<- subset (d.M, d.M$M.XPOS < xCenter+seuils[i] & d.M$M.XPOS > xCenter-seuils[i]
                & d.M$M.YPOS < yCenter+seuils[i] & d.M$M.YPOS > yCenter-seuils[i])
  
  while(i<length(seuils) & length(SUB$M.XPOS)/length(d.M$M.XPOS)<0.85){
    SUB<- subset (d.M, d.M$M.XPOS < xCenter+seuils[i] & d.M$M.XPOS > xCenter-seuils[i]
                  & d.M$M.YPOS < yCenter+seuils[i] & d.M$M.YPOS > yCenter-seuils[i])
    i <- i +1
  }
  seuil<-seuils[i]
  
  # On replace tout sur un point zero ...
  # Qui n'est malheureusement jamais le vrai centre
  # Du fait de la derive de la distribution
  SUB$M.XPOS<-SUB$M.XPOS - xCenter
  SUB$M.YPOS<-SUB$M.YPOS - yCenter
  
  #on regarde les moment ou les deux coordone valent zeros =>recentrement + fin de movement du joueur
  zxy <- (SUB$M.XPOS == 0 & SUB$M.YPOS == 0)
  i<-1
  while(i<length(SUB$M.XPOS) & !zxy[i]){#on cherche la premiere fois ou ca arrive
    i<-i+1
  }
  
  #on s'assure que le premier element n'est pas un recentrage
  while(zxy[i+1]){
    i<-i+1
  }
  
  #on tronque les donnee pour commencer a un endroit bien propre
  SUB<-SUB[-(1:i),]
  zxy<-zxy[-(1:i)]
  
  Rxpos <- numeric(length(zxy)+1)
  Rypos <- numeric(length(zxy)+1)
  Zfol<-rep(TRUE,times=length(zxy)+1)
  
  #on recalcule les vecteur en prenant en compte les fin de mouvement des joueurs
  #et on cherche les fois ou il y as eux recentrage sans mouvement
  for(i in 1:length(zxy)){
    if (zxy[i]){
      Rxpos[i+1]<-SUB$M.XPOS[i]
      Rypos[i+1]<-SUB$M.YPOS[i]
      if(zxy[i-1]){
        Zfol[i]<-FALSE
      }
    }else{
      Rxpos[i+1]<-Rxpos[i]+SUB$M.XPOS[i]
      Rypos[i+1]<-Rypos[i]+SUB$M.YPOS[i]
    }
  }
  
  #on retire de la liste des mouvement les recentrage inutiles et le premier element qui vaut 0
  SUB$M.XPOS<-Rxpos[-1]
  SUB$M.YPOS<-Rypos[-1]
  SUB <- SUB[Zfol,]
  zxy <- zxy[Zfol]
  
  resultats <- data.frame(SUB$M.XPOS,SUB$M.YPOS,SUB$M.TEMPS,zxy)
  
  names(resultats) <- c("M.XPOS","M.YPOS","M.TEMPS","MoveEnd")
  
  return(resultats)
  
}
  
