
#==#==#==#==#

# Fonction souris.decentrage : annule le rencentrage des mouvement de la souris par les jeux

# Return : les nouvelles donnee de mouvement de souris avec les mouvements deplies

#==#==#==#==#

souris.decentrage <- function (donneeSouris, infobaz) {
  # On slectionne les valeurs medianne
  xCenter <- median (donneeSouris$M.XPOS)
  yCenter <- median (donneeSouris$M.YPOS)
  
  # On suprime tout ce qui as ete capture hors du jeu avec un seuil arbitraire de 85%
  # qui marche assez bien pour les petite session et devrais aussi bien marcher sur les plus longues
  seuils <- seq(10, 50, by = 10)
  i <- 1
  dataSubset <- subset (
    donneeSouris,
    donneeSouris$M.XPOS < xCenter + seuils[i] &
      donneeSouris$M.XPOS > xCenter - seuils[i]
    &
      donneeSouris$M.YPOS < yCenter + seuils[i] &
      donneeSouris$M.YPOS > yCenter - seuils[i])
  
  while (i < length(seuils) &
         length(dataSubset$M.XPOS) / length(donneeSouris$M.XPOS) < 0.85) {
    
    dataSubset <- subset (
      donneeSouris,
      donneeSouris$M.XPOS < xCenter + seuils[i] &
        donneeSouris$M.XPOS > xCenter - seuils[i]
      &
        donneeSouris$M.YPOS < yCenter + seuils[i] &
        donneeSouris$M.YPOS > yCenter - seuils[i])
    
    i <- i + 1
  }
  
  # On replace tout sur un point zero ...
  # Qui n'est malheureusement jamais le vrai centre
  # Du fait de la derive de la distribution
  dataSubset$M.XPOS <- dataSubset$M.XPOS - xCenter
  dataSubset$M.YPOS <- dataSubset$M.YPOS - yCenter
  
  #on regarde les moment ou les deux coordone valent zeros =>recentrement + fin de movement du joueur
  moveEnd <- (dataSubset$M.XPOS == 0 & dataSubset$M.YPOS == 0)
  i <- 1
  while (i < length(dataSubset$M.XPOS) &
         !moveEnd[i]) {
    
    #on cherche la premiere fois ou ca arrive
    i <- i + 1
  }
  
  #on s'assure que le premier element n'est pas un recentrage
  while (moveEnd[i + 1]) {
    i <- i + 1
  }
  
  #on tronque les donnee pour commencer a un endroit bien propre
  dataSubset <- dataSubset[-(1:i),]
  moveEnd <- moveEnd[-(1:i)]
  
  Rxpos <- numeric(length(moveEnd) + 1)
  Rypos <- numeric(length(moveEnd) + 1)
  duplicateEnd <- rep(TRUE, times = length(moveEnd) + 1)
  
  #on recalcule les vecteur en prenant en compte les fin de mouvement des joueurs
  #et on cherche les fois ou il y as eux recentrage sans mouvement
  for (i in 1:length(moveEnd)) {
    
    if (moveEnd[i]) {
      Rxpos[i + 1] <- dataSubset$M.XPOS[i]
      Rypos[i + 1] <- dataSubset$M.YPOS[i]
      
      if (moveEnd[i - 1]) {
        duplicateEnd[i] <- FALSE
      }
    } else{
      
      Rxpos[i + 1] <- Rxpos[i] + dataSubset$M.XPOS[i]
      Rypos[i + 1] <- Rypos[i] + dataSubset$M.YPOS[i]
    }
  }
  
  #on retire de la liste des mouvement les recentrage inutiles et le premier element qui vaut 0
  dataSubset$M.XPOS <- Rxpos[-1]
  dataSubset$M.YPOS <- Rypos[-1]
  dataSubset <- dataSubset[duplicateEnd,]
  moveEnd <- moveEnd[duplicateEnd]
  
  resultats <-
    data.frame(dataSubset$M.XPOS,
               dataSubset$M.YPOS,
               dataSubset$M.TEMPS,
               moveEnd)
  
  names(resultats) <- c("M.XPOS", "M.YPOS", "M.TEMPS", "MoveEnd")
  
  return(resultats)
  
}
