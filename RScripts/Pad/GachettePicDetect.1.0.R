# GACHETTES
# fonction pour detection des pics appuis et relaches

gachette.pic.detect <- function (gachData) {
  
  l <- nrow (gachData)
  k <- 1
  
  # déplacement du test
  # (gachData$P.VALEUR[i] > gachData$P.VALEUR[i-1]) & (gachData$P.VALEUR[i] > gachData$P.VALEUR[i+1])
  # a l'extérieure de la boucle c'est moins intuitif mais plus rapide et utile pour la suite du code
  testHaut <- (gachData$P.VALEUR[c(-1,-l)] > gachData$P.VALEUR[c(-l,-l+1)]) & (gachData$P.VALEUR[c(-1,-l)] > gachData$P.VALEUR[c(-1:-2)])
  
  lHaut <- length(testHaut)
  
  haut <- data.frame (P.TEMPS=numeric(lHaut),P.VALEUR = numeric(lHaut),
                      P.UPDOWN = factor("Haut"))
  
  for (i in (1:(l-2))) {
    if ( testHaut[i]){
      haut[k,-3] <- gachData[i+1,]
      k <- k+1
    }
  }
  
  k<- 1
  testBas <- (gachData$P.VALEUR[c(-1,-l)] < gachData$P.VALEUR[c(-l,-l+1)]) & (gachData$P.VALEUR[c(-1,-l)] < gachData$P.VALEUR[c(-1:-2)])
  
  lBas <- length(testHaut)
  
  bas <- data.frame (P.TEMPS=numeric(2*lBas),P.VALEUR = numeric(2*lBas), 
                     P.UPDOWN = factor ("Bas"))
  
  for (i in (1:(l-2))) {
    if ( testBas[i]){
      bas[k,-3] <- gachData[i,]
      bas[k+1,-3] <- gachData[i+2,]
      k <- k+2
    }
  }
  
  bas <- bas[bas$P.TEMPS != 0,]
  haut <- haut[haut$P.TEMPS != 0,]
  
  # reconstituer tableau des appuis haut et bas sur la gachette
  
  lignea <- cbind (gachData[1,],P.UPDOWN ="Bas")
  ligneb <- cbind (gachData[nrow(gachData),],P.UPDOWN ="Bas")
  pics <- rbind (lignea,ligneb,haut,bas)
  pics <- pics [order(pics$P.TEMPS),]
  
  # on nettoye les erreurs : haut successifs (rang 1, rang 2)
  poshaut <- grep ("Haut", pics$P.UPDOWN)
  dumbH <- grep ("Haut",pics$P.UPDOWN[poshaut+1])
  dumbH <- poshaut[dumbH]
  if (sum(dumbH) > 0) {pics <- pics[-dumbH,]}
  
  poshaut <- grep ("Haut", pics$P.UPDOWN)
  dumbH <- grep ("Haut",pics$P.UPDOWN[poshaut+2])
  dumbH <- poshaut[dumbH]
  if (sum(dumbH) > 0) {pics <- pics[-dumbH,]}
  
  return(pics)
  
}