# GACHETTES
# fonction pour detection des pics appuis et relaches

gachette.pic.detect <- function (gachData) {
  
  l <- nrow (gachData)
  k <- 1
  
  ## on détecte les maximum et minimum locaux, un maximum correspond a la fin de la pression sur la gachette 
  # un minimum soit a un début de pression soit a une fin de relachement
  
  # déplacement du test
  # (gachData$P.VALEUR[i] > gachData$P.VALEUR[i-1]) & (gachData$P.VALEUR[i] > gachData$P.VALEUR[i+1])
  # a l'extérieure de la boucle c'est moins intuitif mais plus rapide et utile pour la suite du code
  testHaut <- c(FALSE,
                (gachData$P.VALEUR[c(-1,-l)] > gachData$P.VALEUR[c(-l,-l+1)]) & (gachData$P.VALEUR[c(-1,-l)] > gachData$P.VALEUR[c(-1:-2)]),
                FALSE)
  
  lHaut <- length(testHaut)
  
  haut <- data.frame (P.VALEUR = gachData$P.VALEUR[testHaut],P.TEMPS = gachData$P.TEMPS[testHaut],
                      P.UPDOWN = factor("Haut"))
  
  testHaut <- testHaut[c(-1,-lHaut)]
  
  k<- 1
  testBas <- (gachData$P.VALEUR[c(-1,-l)] < gachData$P.VALEUR[c(-l,-l+1)]) & (gachData$P.VALEUR[c(-1,-l)] < gachData$P.VALEUR[c(-1:-2)])
  
  lBas <- length(testBas)
  
  bas <- data.frame (P.VALEUR = numeric(2*lBas),P.TEMPS=numeric(2*lBas), 
                     P.UPDOWN = factor ("Bas"))
  
  for (i in which(testBas)) {
      
      # On garde le précedent du minimum et sont suivant l'écart entre les deux est l'écart entre appuis
      # si le précedent est un haut on prend celui du milieux
      if (i != 1 && testHaut[i-1]){
        bas[k,-3] <- gachData[i+1,]
      } else {
        bas[k,-3] <- gachData[i,]
      }
      
      # si le suivant est un haut on prend le milieux
      if(testHaut[i+1]){
        bas[k+1,-3] <- gachData[i+1,]
      }else{
        bas[k+1,-3] <- gachData[i+2,]
      }
      
      # on as comme risque d'avoir un écart entre appuis de 0 car un bas serais entourer de deux Haut 
      # mais c'est moins problematique que d'avoir des appuis de plus de 1000s
      
      k <- k+2
  }
  
  # on suprime les eventuelle ligne superflus
  bas <- bas[bas$P.TEMPS != 0,]
  haut <- haut[haut$P.TEMPS != 0,]
  
  # on nettoie les Haut avec une valeur de moins de 0.4 (a ajuster) pour eviter des aberations du a des micros appuis
  haut <- haut[haut$P.VALEUR > 0.4,]
  
  # reconstituer tableau des appuis haut et bas sur la gachette
  
  lignea <- cbind (gachData[1,],P.UPDOWN ="Bas")
  ligneb <- cbind (gachData[nrow(gachData),],P.UPDOWN ="Bas")
  
  pics <- rbind (lignea,ligneb,bas,haut)
  pics <- pics [order(pics$P.TEMPS),]
  
  # on nettoye les erreurs : haut successifs au rang 2 inutile de faire ceux au rang 1 il sont impossible
  
  poshaut <- grep ("Haut", pics$P.UPDOWN)
  dumbH <- grep ("Haut",pics$P.UPDOWN[poshaut+2])
  dumbH <- poshaut[dumbH] + 2
  if (sum(dumbH) > 0) {pics <- pics[-dumbH,]}
  
  return(pics)
  
}
