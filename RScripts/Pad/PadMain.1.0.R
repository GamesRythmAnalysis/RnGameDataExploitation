# Analyse Pad
# Fonction pour l'analyse du Pad Rythmanalyse

pad.main <- function (padData,infobaz,graph) { #possibilite de repasser valfreq pour touches freq. en argument
  # button change et analog change ne changent pas selon systeme et langue
  # mais les designations ensuite changent ! Source de bugs
  # determiner les bons tests 
  
  # separer appuis : boutons
  codeDpad <- c ("Commande de pouce","pov")
  boutData <- subset (padData, (padData$P.ANALOG == "button change" & !(padData$P.TOUCHE %in% codeDpad)))
  boutData$P.TOUCHE <- droplevels (boutData$P.TOUCHE)
  
  # separer DPAD
  # On cherche le prochain 0 ? Et le reste est considere appui continu ...
  # Donc code commande de pouce pourrait suffire 
  dpadData <- subset (padData, padData$P.ANALOG == "button change" & padData$P.TOUCHE %in% codeDpad)
  dpadData$P.TOUCHE <- droplevels (dpadData$P.TOUCHE)
  
  # separer gachettes
  gachData <- subset (padData, padData$P.ANALOG == "analog change" & grepl ("z",padData$P.TOUCHE,ignore.case=TRUE) == TRUE)
  gachData$P.TOUCHE <- droplevels (gachData$P.TOUCHE)
  
  # separer mouvement des sticks (analogique, mais sans gachettes traitees comme boutons)
  stickData <- subset (padData, padData$P.ANALOG == "analog change" & grepl ("z",padData$P.TOUCHE,ignore.case=TRUE) == FALSE)
  stickData$P.TOUCHE <- droplevels (stickData$P.TOUCHE)
  
  # P.DuM # Duree en minute de l'activite pad
  P.DuS <- (max (padData$P.TEMPS)-min (padData$P.TEMPS))
  P.DuM <- P.DuS / 60
  
  boutonResult <- pad.bouton.analyse(boutData)
  
  gachetteResult <- pad.gachette.analyse(gachData)
  boutonResult <- rbind(boutonResult,gachetteResult[1:3])
  
  boutonResult <- boutonResult[order(boutonResult$down.time),]
  
  boutonEntreApp <- boutonResult$down.time[-1] - boutonResult$down.time[-nrow(boutonResult)]
  
  #==#==#==#==#
  
  # P.durApMoy              # duree d'appuis moyenne des touches
  # P.durApSD               # ecart type
  # P.durApTot              # cumule des duree d'appuis des touches
  # P.durEntreApMoy         # duree moyenne entre deux appuis
  # P.durEntreApSD          # ecrat type
  # P.vitPresGachetteMoy    # vitesse moyenne de pression des gachettes en %/s 
  # P.vitPresGachetteSD     # ecart type
  # P.vitRelachGachetteMoy  # vitesse moyenne de relachement des gachette en %/s
  # P.vitRelachGachetteSD   # ecart type
  
  #==#==#==#==#
  
  resultats <- data.frame(
    P.durApMoy <- mean(boutonResult$durApp),
    P.durApSD <- sd(boutonResult$durApp),
    P.durApTot <- sum(boutonResult$durApp),
    P.durEntreApMoy <- mean(entreApp),
    P.durEntreApSD <- sd(entreApp),
    P.vitPresGachetteMoy <- mean(gachetteResult$vit.pression),
    P.vitPresGachetteSD <- sd(gachetteResult$vit.pression),
    P.vitRelachGachetteMoy <- mean(gachetteResult$vit.relache),
    P.vitRelachGachetteSD <- sd(gachetteResult$vit.relache))
  
  return (resultats)
}
