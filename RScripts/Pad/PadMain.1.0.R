# Analyse Pad
# Fonction pour l'analyse du Pad Rythmanalyse

pad.main <- function (d.P,infobaz,graph) { #possibilite de repasser valfreq pour touches freq. en argument
  # button change et analog change ne changent pas selon systeme et langue
  # mais les designations ensuite changent ! Source de bugs
  # determiner les bons tests 
  
  # separer appuis : boutons
  codeDpad <- c ("Commande de pouce","pov")
  bout <- subset (d.P, (d.P$P.ANALOG == "button change" & !(d.P$P.TOUCHE %in% codeDpad)))
  bout$P.TOUCHE <- droplevels (bout$P.TOUCHE)
  
  # separer DPAD
  # On cherche le prochain 0 ? Et le reste est considere appui continu ...
  # Donc code commande de pouce pourrait suffire 
  dpad <- subset (d.P, d.P$P.ANALOG == "button change" & d.P$P.TOUCHE %in% codeDpad)
  dpad$P.TOUCHE <- droplevels (dpad$P.TOUCHE)
  
  # separer gachettes
  gach <- subset (d.P, d.P$P.ANALOG == "analog change" & grepl ("z",d.P$P.TOUCHE,ignore.case=TRUE) == TRUE)
  gach$P.TOUCHE <- droplevels (gach$P.TOUCHE)
  
  # separer mouvement des sticks (analogique, mais sans gachettes traitees comme boutons)
  stick <- subset (d.P, d.P$P.ANALOG == "analog change" & grepl ("z",d.P$P.TOUCHE,ignore.case=TRUE) == FALSE)
  stick$P.TOUCHE <- droplevels (stick$P.TOUCHE)
  
  # nrow (d.P) == nrow (bout)+nrow (dpad)+nrow (stick)+nrow(gach)
  
  # P.DuM # Duree en minute de l'activite pad
  P.DuS <- (max (d.P$P.TEMPS)-min (d.P$P.TEMPS))
  P.DuM <- P.DuS / 60
  
  r <- pad.boutton.analyse(bout)
  
  results <- r[[1]]
  timingAppui <- r[[2]]
  
  
  ## DPAD
  if (nrow (dpad) > 0){
    nbapp <- nrow (subset (dpad, dpad$P.VALEUR == 0))
    posZ <- grep ("TRUE",dpad$P.VALEUR == 0)
    entrapp <- mean (dpad$P.TEMPS[posZ[1:length(posZ)-1]+1]-dpad$P.TEMPS[posZ[1:length(posZ)-1]])
    entrappSD <- sd (dpad$P.TEMPS[posZ[1:length(posZ)-1]+1]-dpad$P.TEMPS[posZ[1:length(posZ)-1]])
    durapp <- mean (dpad$P.TEMPS[posZ[2:length(posZ)]]-dpad$P.TEMPS[posZ[1:length(posZ)-1]+1])
    durapptot <- sum (dpad$P.TEMPS[posZ[2:length(posZ)]]-dpad$P.TEMPS[posZ[1:length(posZ)-1]+1])
    durappSD <- sd (dpad$P.TEMPS[posZ[2:length(posZ)]]-dpad$P.TEMPS[posZ[1:length(posZ)-1]+1])
    ligne <- data.frame (P.TOUCHE = "DPAD", P.NbAppuis = nbapp,
                         P.TpMoyEntreAppuis = entrapp, P.TpSDEntreAppuis = entrappSD,
                         P.TpMoyAppui = durapp, P.DurAppuiTot = durapptot, P.TpSDAppui = durappSD)
    results <- rbind(results,ligne)
    timingAppui <- rbind (timingAppui, data.frame (P.TOUCHE = "DPAD", P.TEMPS = subset (dpad, P.VALEUR > 0)$P.TEMPS))
  }
  
  ## Nombre de touches utilisees
  ## Aise de reinteger ici la mesure alter. DPAD vu que appuis dans timingappui sont traites > 0
  P.NbTouches <- nrow (results)
  P.NbAppuis <- sum (results$P.NbAppuis)
  P.NbAppuisS <- P.NbAppuis / P.DuS
  valfreq <- 0.01 * P.NbAppuis
  P.NbTouchesFreq <- nrow (subset (results, results$P.NbAppuis > valfreq))
  
  ## Valeurs globales
  P.TpMoyEntreAppuis <- sum ((results$P.NbAppuis*results$P.TpMoyEntreAppuis),na.rm=TRUE)/P.NbAppuis
  P.TpSDEntreAppuis <- sum ((results$P.NbAppuis*results$P.TpSDEntreAppuis),na.rm=TRUE)/P.NbAppuis
  P.TpMoyAppui <- sum ((results$P.NbAppuis*results$P.TpMoyAppui),na.rm=TRUE)/P.NbAppuis
  P.TpSDAppui <- sum ((results$P.NbAppuis*results$P.TpSDAppui),na.rm=TRUE)/P.NbAppuis
  
  ## Valeurs touche la plus frequente (attention max engendre erreur si null)
  if (!is.null (results$P.NbAppuis)) {
    P.ToucheFreq <- subset (results, results$P.NbAppuis == max (results$P.NbAppuis))$P.TOUCHE
    P.ToucheFreq <- P.ToucheFreq[1]
    P.PropFreq <- (results$P.NbAppuis[results$P.TOUCHE==P.ToucheFreq]/P.NbAppuis)*100
    P.TpMoyEntreAppuisFreq <- results$P.TpMoyEntreAppuis[results$P.TOUCHE==P.ToucheFreq]	
    P.TpSDEntreAppuisFreq <- results$P.TpSDEntreAppuis[results$P.TOUCHE==P.ToucheFreq]	
    P.TpMoyAppuiFreq <- results$P.TpMoyAppui[results$P.TOUCHE==P.ToucheFreq]	
    P.TpSDAppuiFreq <- results$P.TpSDAppui[results$P.TOUCHE==P.ToucheFreq]
    
    if (graph == TRUE) {
      graphiques.pad.touches (timingAppui,P.NbTouchesFreq, P.DuM, results, infobaz)
    }
    
    
  } else 
  {
    P.ToucheFreq <- NA
    P.PropFreq <- NA
    P.TpMoyEntreAppuisFreq <- NA
    P.TpSDEntreAppuisFreq <- NA
    P.TpMoyAppuiFreq <- NA
    P.TpSDAppuiFreq <- NA
  }
  
  ## STICK
  # distintguer Stick gauche (Axe Y, Axe X) / Stick (Rotation Y, Rotation X)
  # sous linux : 
  
  stickG <- subset (stick, grepl ("r", stick$P.TOUCHE, ignore.case=TRUE) == FALSE)
  stickD <- subset (stick, grepl ("r", stick$P.TOUCHE, ignore.case=TRUE) == TRUE)
  
  # recreer les coordonnees x/y a chaque temps
  AnalyseStick <- function (stickdata) {
    
    condition <- grepl ("y",stickdata$P.TOUCHE,ignore.case =TRUE)
    Y <- ifelse (condition,stickdata$P.VALEUR,NA)
    Y <- c (0,Y)
    condition <- is.na (Y)
    for (i in 2:length(Y)){
      if (condition[i]){
        Y[i] <- Y[i-1]
      }
    }
    
    condition <- grepl ("y",stickdata$P.TOUCHE,ignore.case =TRUE)
    X <- ifelse (!condition,stickdata$P.VALEUR,NA)
    X <- c (0,X)
    condition <- is.na (X)
    for (i in 2:length(X)){
      if (condition[i]){
        X[i] <- X[i-1]
      }
    }
    
    stickXY <- data.frame (P.TEMPS=stickdata$P.TEMPS, X = X[-1], 
                           Y = Y[-1])
  }
  
  if (nrow(stickG)>100){
    stickG <- AnalyseStick(stickG)
    DifX <- stickG$X[2:length(stickG$X)] - stickG$X[1:length(stickG$X)-1]
    DifY <- stickG$Y[2:length(stickG$Y)] - stickG$Y[1:length(stickG$Y)-1]
    P.VitG <- sum (sqrt (DifX^2 +DifY^2)) / max (stickG$P.TEMPS)    
  } else 
  {P.VitG <- 0}
  
  if (nrow(stickD)>100){
    stickD <- AnalyseStick(stickD)
    DifX <- stickG$X[2:length(stickG$X)] - stickG$X[1:length(stickG$X)-1]
    DifY <- stickG$Y[2:length(stickG$Y)] - stickG$Y[1:length(stickG$Y)-1]
    P.VitD <- sum (sqrt (DifX^2 +DifY^2)) / max (stickD$P.TEMPS)    
  } else 
  {P.VitD <- 0}
  
  
  
  ##
  # stickData <- stickG
  ##
  
  if (graph == TRUE) {
    if (nrow(stickG)>100) {
      plotG<-plotStick (stickG,paste(infobaz,"\n","Mouvement Stick Gauche"),paste (infobaz,".LStick",".png", sep =""))
    }
    if (nrow(stickD)>100) {
      plotD <- plotStick (stickD,paste(infobaz,"\n","Mouvement Stick Droit"),paste (infobaz,".RStick",".png", sep =""))
    }
    
    if (exists("plotG", environment()) & exists ("plotD", environment())) {
      png (filename = paste (infobaz,".Sticks",".png", sep =""), width = 1500, height = 700)
      grid.arrange(plotG, plotD, nrow=1, ncol=2)
      dev.off()
    }
  }
  
  P.Vit = P.VitG + P.VitD
  
  ##
  # Plot DPAD
  ##
  if (graph == TRUE) {
    if (nrow (dpad) > 100) {
      plotdpad (dpad,infobaz)
    }
  }
  
  
  P.NbAppuis # Nombre total d'appuis
  P.DuM # Duree en minute de l'activite pad
  P.NbAppuisS # Appuis par seconde
  if (is.null (P.NbTouches)) {P.NbTouches<-0} # Nombre de touches utilisees
  if (is.null (P.NbTouchesFreq)) {P.NbTouchesFreq<-0} # Nombre de touches frequemment utilisees (enlever inf. a valfreq 1%)
  P.TpMoyEntreAppuis # Temps moyen entre appuis  
  P.TpSDEntreAppuis # Ecart-type
  P.TpMoyAppui # Duree moyenne d'un appui
  P.TpSDAppui # Ecart-type duree d'un appui
  P.Vit # vitesse moyenne cumulee des deplacements des sticks
  P.VitG # vitesse Stick gauche
  P.VitD # vitesse stick droit
  P.ToucheFreq
  P.TpMoyEntreAppuisFreq
  P.TpSDEntreAppuisFreq 
  P.TpMoyAppuiFreq
  P.TpSDAppuiFreq
  
  
  resultats <- data.frame(P.DuM,P.NbTouches,P.NbTouchesFreq,
                          P.NbAppuis,P.NbAppuisS,
                          P.TpMoyEntreAppuis,P.TpSDEntreAppuis, 
                          P.TpMoyAppui,P.TpSDAppui,
                          P.ToucheFreq,P.PropFreq,
                          P.TpMoyEntreAppuisFreq,P.TpSDEntreAppuisFreq, 
                          P.TpMoyAppuiFreq,P.TpSDAppuiFreq,
                          P.Vit,P.VitG,P.VitD)
  return (resultats)
}
