# Analyse Pad
# Fonction pour l'analyse du Pad Rythmanalyse

pad.main <- function (padData, infobaz, graph) {
  
  #possibilite de repasser valfreq pour touches freq. en argument
  # button change et analog change ne changent pas selon systeme et langue
  # mais les designations ensuite changent ! Source de bugs
  # determiner les bons tests
  
  # separer appuis : boutons
  codeDpad <- c ("Commande de pouce", "pov")
  boutData <-
    subset (padData, (
      padData$P.ANALOG == "button change" &
        !(padData$P.TOUCHE %in% codeDpad)
    ))
  boutData$P.TOUCHE <- droplevels (boutData$P.TOUCHE)
  
  # separer DPAD
  # On cherche le prochain 0 ? Et le reste est considere appui continu ...
  # Donc code commande de pouce pourrait suffire
  dpadData <-
    subset (padData,
            padData$P.ANALOG == "button change" &
              padData$P.TOUCHE %in% codeDpad)
  dpadData$P.TOUCHE <- droplevels (dpadData$P.TOUCHE)
  
  # separer gachettes
  gachData <-
    subset (
      padData,
      padData$P.ANALOG == "analog change" &
        grepl ("z", padData$P.TOUCHE, ignore.case = TRUE) == TRUE
    )
  gachData$P.TOUCHE <- droplevels (gachData$P.TOUCHE)
  
  # separer mouvement des sticks (analogique, mais sans gachettes traitees comme boutons)
  stickData <-
    subset (
      padData,
      padData$P.ANALOG == "analog change" &
        grepl ("z", padData$P.TOUCHE, ignore.case = TRUE) == FALSE
    )
  stickData$P.TOUCHE <- droplevels (stickData$P.TOUCHE)
  
  # P.DuM Duree en minute de l'activite pad
  P.DuS <- (max (padData$P.TEMPS) - min (padData$P.TEMPS))
  P.DuM <- P.DuS / 60
  
  
  boutonResult <- pad.bouton.analyse(boutData)
  
  gachetteResult <- pad.gachette.analyse(gachData)
  boutonResult <- rbind(boutonResult, gachetteResult[1:3])
  
  # on trie par ordre chronologique sinon plus rien n'as de sens
  boutonResult <- boutonResult[order(boutonResult$down.time), ]
  
  # calcules des temps entre appuis
  boutonEntreApp <-
    boutonResult$down.time[-1] - boutonResult$down.time[-nrow(boutonResult)] - boutonResult$durApp[-nrow(boutonResult)]
  
  # on determine les bouton frequent
  P.NbAppuis <- nrow(boutonResult)
  VALFREQ <- 0.01 * P.NbAppuis
  
  tableBouton <- sort(table(boutonResult$bouton), decreasing = TRUE)
  bouttonFreq <- subset (tableBouton,
                         tableBouton > VALFREQ)
  
  # On ne conserve que la touche la plus frequente
  mostFreq <- subset (boutonResult,
                      boutonResult$bouton == names (bouttonFreq[1]))
  mostFreqEntreAp <-
    mostFreq$down.time[-1] - mostFreq$down.time[-nrow(mostFreq)] - mostFreq$durApp[c(-1,-nrow(mostFreq))]
  
  P.DurApMoy <- mean(boutonResult$durApp)
  P.DurApSD <- sd(boutonResult$durApp)
  P.DurApTot <- sum(boutonResult$durApp)
  P.TpEntreApMoy <- mean(boutonEntreApp)
  P.TprEntreApSD <- sd(boutonEntreApp)
  
  P.NbBouton <- length(levels(boutonResult$bouton))
  P.NbAppuisS <- P.NbAppuis / P.DuS
  P.NbBoutonFreq <- length(bouttonFreq)
  
  P.BoutFreq <- mostFreq$bouton[1]
  P.PropFreq <- (nrow (mostFreq) / P.NbAppuis) * 100
  P.durApFreqMoy <- mean(mostFreq$durApp)
  P.durApFreqSD <- sd(mostFreq$durApp)
  P.TpEntreAppuisFreqMoy <- mean(mostFreqEntreAp)
  P.TpEntreAppuisFreqSD <- sd(mostFreqEntreAp)
  
  P.VitPresGachetteMoy <- mean(gachetteResult$vit.pression)
  P.VitPresGachetteSD <- sd(gachetteResult$vit.pression)
  P.VitRelachGachetteMoy <- mean(gachetteResult$vit.relache)
  P.VitRelachGachetteSD <- sd(gachetteResult$vit.relache)
  
  #==#==#==#==#
  
  # P.DuM                   # durée en seconde de la session
  
  # P.durApMoy              # duree d'appuis moyenne des touches
  # P.durApSD               # ecart type
  # P.durApTot              # cumule des duree d'appuis des touches
  # P.TpEntreApMoy          # duree moyenne entre deux appuis
  # P.TpEntreApSD           # ecrat type
  
  # P.NbBouton              # nombre de bouton utilisé
  # P.NbAppuis              # nombre d'appuis
  # P.NbAppuisS             # nombre d'appuis par seconde
  # P.NbBoutonFreq          # nombre de bouton freq : ceux qui représente + de 1% du nombre d'appuis
  
  # P.BoutFreq              # le bouton le plus utilisé
  # P.PropFreq              # proportion d'utilisation de se bouton
  # P.durApFreqMoy          # duree d'appuis moyenne dela touche la plus frequente
  # P.durApFreqSD           # ecart type
  # P.TpEntreAppuisFreqMoy  # duree moyenne entre deux appuis
  # P.TpEntreAppuisFreqSD   # ecart type
  
  # P.vitPresGachetteMoy    # vitesse moyenne de pression des gachettes en %/s
  # P.vitPresGachetteSD     # ecart type
  # P.vitRelachGachetteMoy  # vitesse moyenne de relachement des gachette en %/s
  # P.vitRelachGachetteSD   # ecart type
  
  #==#==#==#==#
  
  resultats <- data.frame(
    P.DuM,
    
    P.DurApMoy,
    P.DurApSD,
    P.DurApTot,
    P.TpEntreApMoy,
    P.TprEntreApSD,
    
    P.NbBouton,
    P.NbAppuis,
    P.NbAppuisS,
    P.NbBoutonFreq,
    
    P.BoutFreq,
    P.PropFreq,
    P.durApFreqMoy,
    P.durApFreqSD,
    P.TpEntreAppuisFreqMoy,
    P.TpEntreAppuisFreqSD,
    
    P.VitPresGachetteMoy,
    P.VitPresGachetteSD,
    P.VitRelachGachetteMoy,
    P.VitRelachGachetteSD
  )
  
  return (resultats)
}
