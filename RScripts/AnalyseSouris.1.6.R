# Analyse Souris
# Fonction pour analyse de la souris Rythmanalyse

AnalyseSouris <- function (d.M,infobaz,graph) {
  
  # Nombre clics (distinguer droit et gauche) / repartion en % gauche
  d.McL <- subset (d.M, M.EVENEMENT == "mouse 1 down")
  d.McR <- subset (d.M, M.EVENEMENT == "mouse 2 down")
  d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
  M.NbClics <- length (d.Mc$M.TEMPS)
  M.LR <- length (d.McL$M.TEMPS)/length (d.Mc$M.TEMPS) * 100 # pourcentage clic gauche
  
  d.Mscroll <- filter (d.M, M.EVENEMENT %in% c ("mouse scroll down", "mouse scroll up"))
  M.Scroll <- nrow (d.Mscroll)/(M.NbClics + nrow (d.Mscroll))*100 # pourcentage scroll
  
  # Duree secondes, minutes activite souris
  M.DuS <- max (d.M$M.TEMPS) - min (d.M$M.TEMPS)
  M.DuM <- M.DuS / 60
  
  # Nombre clics par seconde
  M.NbCliclsS <- M.NbClics / M.DuS
  
  # Temps entre deux clics et ecart-type
  M.TpEntreAppuis <- d.Mc$M.TEMPS[2:length(d.Mc$M.TEMPS)]-d.Mc$M.TEMPS[1:length(d.Mc$M.TEMPS)-1]
  M.TpMoyEntreAppuis <- mean ( M.TpEntreAppuis)
  M.TpSDEntreAppuis <- sd (M.TpEntreAppuis)
  
  #Duree reel d'activite des clicks duree moyen des click
  mouse_L_rythm <- GetMouseRythm("mouse 1")
  mouse_R_rythm <- GetMouseRythm("mouse 2")
  M.TpsClickR<- sum(mouse_R_rythm$duration,na.rm=TRUE)
  M.TpsClickL<- sum(mouse_L_rythm$duration,na.rm=TRUE)
  M.TpsTotClick <- M.TpsClickL + M.TpsClickR
  M.MoyTpsClickR <- mean(mouse_R_rythm$duration,na.rm=TRUE)
  M.SDTpsClickR <- sd(mouse_R_rythm$duration,na.rm=TRUE)
  M.MoyTpsClickL <- mean(mouse_L_rythm$duration,na.rm=TRUE)
  M.SDTpsClickL <- sd(mouse_L_rythm$duration,na.rm=TRUE)
  
  # On determine s'il y a recentrage
  cond1 <- fivenum(d.M$M.XPOS)[4]-fivenum(d.M$M.XPOS)[2]
  cond2 <- fivenum(d.M$M.YPOS)[4]-fivenum(d.M$M.YPOS)[2]
  
  ifelse (cond1 > 20 & cond2 > 20,
          recentre <- FALSE,
          recentre <- TRUE)
  
  if (recentre == FALSE) {
    DifX <- (d.M$M.XPOS[2:length(d.M$M.XPOS)] - d.M$M.XPOS[1:length(d.M$M.XPOS)-1])
    DifY <- d.M$M.YPOS[2:length(d.M$M.YPOS)] - d.M$M.YPOS[1:length(d.M$M.YPOS)-1]
    M.Vit <- sum (sqrt (DifX^2 +DifY^2)) / max (d.M$M.TEMPS)
    M.VitTrueXY <- TRUE
  }
  
  if (recentre == TRUE) {
    M.Vit <- recentrage (d.M,infobaz)
    M.VitTrueXY <- FALSE
  }
  
  if (graph == TRUE) {
    graphiques.souris (d.M, M.DuM,recentre, infobaz)
  }
  
  #M.DuM # Duree activite souris en minutes
  #M.NbClics # Nombre total d'appuis
  #M.NbCliclsS # Clics par seconde
  #M.TpsClickR #Temps cumuler a faire click droit
  #M.TpsClickL #Temps cumuler a faire click gauche 
  #M.TpsTotClick #Temps Cumuler a clicker
  #M.MoyTpsClickR #Temps moyen d'un click droit
  #M.SDTpsClickR #Ecart type du temps d'un click droit
  #M.MoyTpsClickL #Temps moyen d'un click gauche
  #M.SDTpsClickL #Ecart type du temps d'un click gauche
  #M.LR # Pourcentage de clics gauche
  #M.TpMoyEntreAppuis # Temps moyen entre deux appuis
  #M.TpSDEntreAppuis # Ecart type entre deux appuis
  #M.Vit # Moyenne des vitesses instantanes
  #M.VitTrueXY #si la vitesse est calculer a partir des vraie coordonn?e ou apr?s une modification
  
  resultats <- data.frame(M.DuM,M.NbClics,M.NbCliclsS,
                          M.TpsClickR,M.TpsClickL,
                          M.TpsTotClick,M.MoyTpsClickR,
                          M.SDTpsClickR,M.MoyTpsClickL,M.SDTpsClickL,
                          M.LR, M.Scroll,
                          M.TpMoyEntreAppuis,M.TpSDEntreAppuis,
                          M.Vit,M.VitTrueXY)
  return (resultats)
}
