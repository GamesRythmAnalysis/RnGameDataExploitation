## Rythmanalyse fonction v.2 Nouveau Format P16
## From Scratch Optimisation

# ToDO
# Virer les boucles inutiles
# Point sur les indicateurs : durée moy. touche + freq ?
# Visualisation hotmap sous R
# Le problème de la vitesse souris ?

# PROBLEMES NOUVEAU FORMAT !
# ok / csv est sur un autre modèle ! pas le même séparateur !
# ok / d.M$M.EVENEMENT # mouse left down est devenu mouse 1 down ; idem, right 2
# ok / d.K$K.EVENEMENT # key down est devenu Key Down ; idem Key Up
# ok / pas même unité temporelle : convertir en secondes
# Perte de grain à repasser tout de suite en secondes ? 
# ok / pas même logique pour enregistrement clavier Key Down pas suivi Key Up
# intégrer tous les boutons de la souris : mouse X down
# modifier la stratégie d'import ? zip


# rm (list=ls())
# setwd("~/Documents/Projets R/Rythmanalyse/Zone Travail/Analyse")

# Rythmanalyse("2016.03.24.MT.Gardenarium.zip")

Rythmanalyse <- function (nomfichier){ # type : "2014.02.16.MT.Doom.s1.zip"
  ImportZip <- function (nomfichier) {  # o? nomfichier est du type "2014.02.16.MT.Doom.s1.zip"
    unzip (nomfichier)
    tmp <- substr (nomfichier, 1, nchar (nomfichier)-4)
    fichiersouris <- paste (tmp,".M",".csv",sep="")
    fichierclavier <- paste (tmp,".K",".csv",sep="")
    fichierpad <- paste (tmp,".P",".csv",sep="")
    #Recuperer les donnees des .csv avec un check d'existence pour ne pas engendrer d'erreurs
    # Export en variable globale <<-
    testf <- file.access(c(fichiersouris,fichierclavier,fichierpad))
    if (testf[1] == 0) {d.M <<- read.csv2(fichiersouris, dec=".")
    names (d.M) <<- c("M.EVENEMENT", "M.XPOS", "M.YPOS", "M.TEMPS")
    d.M$M.TEMPS <<- d.M$M.TEMPS / 1000 # Passer l'unité de temps en secondes
    if (length(d.M$M.EVENEMENT) < 5) {rm (d.M,envir = .GlobalEnv)} 
    } 
    if (testf[2] == 0) {d.K <<- read.csv2(fichierclavier, dec=".")
    names (d.K) <<- c("K.EVENEMENT","K.TOUCHE","K.TEMPS")
    d.K$K.TEMPS <<- d.K$K.TEMPS / 1000 # Passer l'unité de temps en secondes
    if (length(d.K$K.EVENEMENT) < 5) {rm (d.K,envir = .GlobalEnv)} 
    }
    if (testf[3] == 0) {d.P <<- read.csv2(fichierpad, dec=".")
    names (d.P) <<- c("P.TEMPS","P.STICK.G.HORIZ","P.STICK.G.VERTI","P.GACHETTES","P.STICK.D.VERTI","P.STICK.D.HORIZ",
                      "P.A","P.B","P.X","P.Y","P.LB","P.RB","P.SELECT","P.START","P.CLICSTICKG","P.CLICSTICKD",
                      "P.DPAD")
    if (mean(d.P$P.TEMPS) == 0) {rm (d.P,envir = .GlobalEnv)}                         
    } 
    
  }
  ImportOld <- function (nomfichier) {  # o? nomfichier est du type "2013.06.28.MT.KnifeDunwall"
    #Cr?er les noms de fichiers
    fichiersouris <- paste (nomfichier,".M",".txt",sep="")
    fichierclavier <- paste (nomfichier,".K",".txt",sep="")
    ## fichierpad <- paste (nomfichier,".P",".txt",sep="")
    #R?cup?rer les donn?es (faire un check d'existence ? pour ne pas engendrer d'erreurs ?)
    d.M <<- read.delim2(fichiersouris, dec=".") # Export en variable globale <<-
    d.K <- read.delim2(fichierclavier, dec=".") 
    d.K <<- d.K [,c(1,2,4)] # Export en variable globale <<- apr?s nettoyage d'une colonne inutile
    ## d.P <- read.delim2(fichierpad, dec=".")
    names (d.K) <<- c("K.EVENEMENT","K.TOUCHE","K.TEMPS")
    names (d.M) <<- c("M.EVENEMENT","M.TEMPS")
  }
  
    # Analyse Souris
  
  AnalyseSouris <- function (d.M) {
    # Nombre clics (distinguer droit et gauche) / repartion en % gauche
    d.McL <- subset (d.M, M.EVENEMENT == "mouse 1 down")
    d.McR <- subset (d.M, M.EVENEMENT == "mouse 2 down")
    d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
    M.NbClics <- length (d.Mc$M.TEMPS)
    M.LR <- length (d.McL$M.TEMPS)/length (d.Mc$M.TEMPS) * 100 # pourcentage clic gauche
    # Duree secondes, minutes activite souris
    M.DuS <- d.M$M.TEMPS [length(d.M$M.TEMPS)]
    M.DuM <- M.DuS / 60
    # Nombre clics par seconde
    M.NbCliclsS <- M.NbClics / M.DuS
    # Temps entre deux clics et ecart-type
    M.TpEntreAppuis <- d.Mc$M.TEMPS[2:length(d.Mc$M.TEMPS)]-d.Mc$M.TEMPS[1:length(d.Mc$M.TEMPS)-1]
    M.TpMoyEntreAppuis <- mean ( M.TpEntreAppuis)
    M.TpSDEntreAppuis <- sd (M.TpEntreAppuis)
    #M.Vit <- mean (d.M$M.VITESSE)
    if (mean (c(sd (d.M$M.XPOS),sd (d.M$M.YPOS))) > 75) { # On teste si donnees mouvement souris ne sont pas bugges
      DifX <- (d.M$M.XPOS[2:length(d.M$M.XPOS)] - d.M$M.XPOS[1:length(d.M$M.XPOS)-1])
      DifY <- d.M$M.YPOS[2:length(d.M$M.YPOS)] - d.M$M.YPOS[1:length(d.M$M.YPOS)-1]
      M.Vit <- sum (sqrt (DifX^2 +DifY^2)) / max (d.M$M.TEMPS)
    }
    else {M.Vit <- NA}
    
    #M.NbClics # Nombre total d'appuis
    #M.LR # Pourcentage de clics gauche
    #M.DuM # Duree activite souris en minutes
    #M.NbCliclsS # Clics par seconde
    #M.TpMoyEntreAppuis # Temps moyen entre deux appuis
    #M.TpSDEntreAppuis # Ecart type entre deux appuis
    #M.Vit # Moyenne des vitesses instantanées
    
    resultats <- data.frame(M.DuM,M.NbClics,M.NbCliclsS,M.LR,M.TpMoyEntreAppuis,M.TpSDEntreAppuis,M.Vit)
    return (resultats)
  }
  

# Analyse Clavier

## Une fonction qui récupére le rythme d'appui pour une clé.
GetKeyRythm <- function(key){
  ## Un data frame vide pour recevoir les r?sultats
  results <- data.frame("down.time"=numeric(),"duration"=numeric(),"touche"=factor())
  down <- NULL
  ## On est oblig? de passer par une boucle pour parser ligne par ligne
  for (i in 1:nrow(d.K)) {
    ## ignorer les lignes qui concernent une autre cl? que la notre
    if (d.K[i,"K.TOUCHE"] != key) next
    ## Pour la bonne cl?, si l'on rencontre un down, le stocker 
    ##(ainsi, si l'on rencontre deux down de suite, sans up entre les deux, 
    ##le premier sera effa?? et seul le second comptera)
    if (d.K$K.EVENEMENT[i] == "Key Down") {
      down <- d.K[i,]
      next
    }
    ## Si l'on rencontre un up
    if (d.K$K.EVENEMENT[i] == "Key Up") {
      ## v?rifier si l'on a bien eu un down pr?c?demment
      if (is.null(down)== FALSE) {
        ## Calculer la dur?e entre down et up
        duration <- d.K$K.TEMPS[i] - down$K.TEMPS
        down.time <- down$K.TEMPS
        ## cr?er une ligne de data frame avec nom de la cl?, d?but du down, temps du down
        ligne <- c(down.time,duration)
        ## la concat?ner avec les r?sultats pr?c?dents
        results <- rbind(results,ligne)
        ## vider le down (en cas de deux up cons?cutifs, au cas o?)
        down <- NULL}
      #if (is.null(down)== TRUE) { # Traiter erreur dans le cas o? on rencontre d'abord un Up (? n?gliger)
      else
      {
        duration <- NA
        down.time <- NA
        ligne <-c(down.time,duration)
        results <- rbind (results,ligne)
      }
    }
    
    ## ajouter une variable identifiant la cl? pour fusion avec les r?sultats sur les autres cl?
    results$touche <- key
    
  }
  names (results) <- c ("down.time","duration","touche")
  return(results)
}

AnalyseClavier <- function (d.K) { #possibilit? de repasser valfreq pour touches freq. en argument
  # Nombre appuis
  d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
  K.NbAppuis <- length (d.Kdown$K.EVENEMENT)
  # Dur?e secondes, dur?e minutes activit? clavier
  K.DuS <- max (d.K$K.TEMPS, na.rm = TRUE)
  K.DuM <- K.DuS / 60
  # Nombre d'appuis par seconde
  K.NbAppuisS <- K.NbAppuis / K.DuS
  # Nombre de touches utilis?es
  sort(table(d.K$K.TOUCHE), decreasing = TRUE)
  K.NbTouches <- length(levels(d.K$K.TOUCHE))
  # Touches fr?quentes
  valfreq <- 0.01
  tabletouches <- sort(table(d.Kdown$K.TOUCHE),decreasing=TRUE)
  touchesfreq <- subset (tabletouches, tabletouches > K.NbAppuis * valfreq)
  K.NbTouchesFreq <- length (touchesfreq)
  # Temps entre appuis et ?cart-type
  K.TpEntreAppuis <- d.Kdown$K.TEMPS[2:length(d.Kdown$K.TEMPS)]-d.Kdown$K.TEMPS[1:length(d.Kdown$K.TEMPS)-1]
  K.TpMoyEntreAppuis <- mean (K.TpEntreAppuis)
  K.TpSDEntreAppuis <- sd (K.TpEntreAppuis)
  # Dur?e des appuis
  keyboard_rythm <- lapply(levels(d.K$K.TOUCHE),GetKeyRythm)
  keyboard_rythm <- do.call("rbind",keyboard_rythm)
  K.TpMoyAppui <- mean (keyboard_rythm$duration, na.rm = TRUE) # Temps moyen d'un appui
  K.TpSDAppui <- sd (keyboard_rythm$duration, na.rm = TRUE) # Ecart-type temps d'un appui
  
  #K.NbAppuis # Nombre total d'appuis
  #K.DuM # Duree en minute de l'activite clavier
  #K.NbAppuisS # Appuis par seconde
  #K.NbTouches # Nombre de touches utilisees
  #K.NbTouchesFreq # Nombre de touches frequemment utilis?es (enlever inf. ? valfreq 1%)
  #K.TpMoyEntreAppuis # Temps moyen entre appuis  
  #K.TpSDEntreAppuis # Ecart-type
  #K.TpMoyAppui # Duree moyenne d'un appui
  #K.TpSDAppui # Ecart-type duree d'un appui
  
  resultats <- data.frame(K.DuM,K.NbTouches,K.NbTouchesFreq,K.NbAppuis,K.NbAppuisS,K.TpMoyEntreAppuis,K.TpSDEntreAppuis,K.TpMoyAppui,K.TpSDAppui)
  return (resultats)
}

GetPadRythm <- function(key){
  ## Un data frame vide pour recevoir les resultats
  results <- data.frame("timecode"=numeric(),"duree"=numeric(),"touche"=factor())
  down <- NULL
  
  for (i in 1:nrow(d.P)) {
    if ((d.P[i,key] == 1) & (is.null(down) == TRUE)) {
      down <- d.P$P.TEMPS [i]
      next
    }
    if (d.P[i,key] == 0) {
      if (is.null(down) == FALSE) {
        duree <- d.P$P.TEMPS[i] - down
        timecode <- down
        ligne <- c(timecode,duree)
        results <- rbind(results,ligne)
        results$touche <- key
        down <- NULL
      }
      else {
        ##duree <- NA
        ##timecode <- NA
        ##ligne <-c(duree,timecode)
        ##results <- rbind (results,ligne)
      }
    }
  } 
  names (results) <- c ("timecode","duree","touche")
  return(results) 
}

AnalysePad <- function (d.P) { #possibilite de repasser valfreq pour touches freq. en argument
  PadRythmn <- lapply (colnames(d.P[7:14]),GetPadRythm)
  PadRythmn <- do.call ("rbind",PadRythmn)
  PadRythmn <<- na.omit (PadRythmn)
  
  # Nombre appuis
  P.NbAppuis <- length (PadRythmn$duree)
  # Dur?e secondes, dur?e minutes activit? clavier
  P.DuS <- max (d.P$P.TEMPS, na.rm = TRUE)
  P.DuM <- P.DuS / 60
  # Nombre d'appuis par seconde
  P.NbAppuisS <- P.NbAppuis / P.DuS
  # Nombre de touches utilisees
  sort(table(PadRythmn$touche), decreasing = TRUE)
  P.NbTouches <- length(levels (as.factor (PadRythmn$touche)))
  # Touches frequentes
  valfreq <- 0.01
  tabletouches <- sort(table(PadRythmn$touche),decreasing=TRUE)
  touchesfreq <- subset (tabletouches, tabletouches > P.NbAppuis * valfreq)
  P.NbTouchesFreq <- length (touchesfreq)
  # Temps entre appuis et ecart-type
  sortappuis <- sort (PadRythmn$timecode, decreasing = FALSE)
  P.TpEntreAppuis <- sortappuis[2:length(sortappuis)]-sortappuis[1:length(sortappuis)-1]
  P.TpMoyEntreAppuis <- mean (P.TpEntreAppuis)
  P.TpSDEntreAppuis <- sd (P.TpEntreAppuis)
  # Dur?e des appuis
  P.TpMoyAppui <- mean (PadRythmn$duree, na.rm = TRUE) # Temps moyen d'un appui
  P.TpSDAppui <- sd (PadRythmn$duree, na.rm = TRUE) # Ecart-type temps d'un appui
  # Vitesse deplacement sticks
  attach(d.P)
  DifXG <- P.STICK.G.HORIZ[2:length(P.STICK.G.HORIZ)] - P.STICK.G.HORIZ[1:length(P.STICK.G.HORIZ)-1]
  DifYG <- P.STICK.G.VERTI[2:length(P.STICK.G.VERTI)] - P.STICK.G.VERTI[1:length(P.STICK.G.VERTI)-1]
  P.VitG <- sum (sqrt (DifXG^2 +DifYG^2)) / max (P.TEMPS)
  DifXD <- P.STICK.D.HORIZ[2:length(P.STICK.D.HORIZ)] - P.STICK.D.HORIZ[1:length(P.STICK.D.HORIZ)-1]
  DifYD <- P.STICK.D.VERTI[2:length(P.STICK.D.VERTI)] - P.STICK.D.VERTI[1:length(P.STICK.D.VERTI)-1]
  P.VitD <- sum (sqrt (DifXD^2 +DifYD^2)) / max (P.TEMPS)
  P.Vit = sum (c(P.VitG,P.VitD), na.rm = TRUE)
  detach(d.P)
  
  #P.NbAppuis # Nombre total d'appuis
  #P.DuM # Duree en minute de l'activite pad
  #P.NbAppuisS # Appuis par seconde
  #P.NbTouches # Nombre de touches utilis?es
  #P.NbTouchesFreq # Nombre de touches fr?quemment utilis?es (enlever inf. ? valfreq 1%)
  #P.TpMoyEntreAppuis # Temps moyen entre appuis  
  #P.TpSDEntreAppuis # Ecart-type
  #P.TpMoyAppui # Dur?e moyenne d'un appui
  #P.TpSDAppui # Ecart-type dur?e d'un appui
  
  resultats <- data.frame(P.DuM,P.NbTouches,P.NbTouchesFreq,P.NbAppuis,P.NbAppuisS,P.TpMoyEntreAppuis,P.TpSDEntreAppuis, P.TpMoyAppui,P.TpSDAppui,P.Vit)
  return (resultats)
}  

ImportZip (nomfichier)

titre <- substr (nomfichier,15,nchar(nomfichier)-4)
date <- substr (nomfichier,1,10)
usr <- substr (nomfichier,12,13)
Rez <- cbind (nomfichier,date,usr,titre) ## Attention ? tout sortir au meme format pour traitement en masse

if (exists("d.M", environment()) & exists ("d.K", environment())) {
  d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
  d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
  densK <- density (d.Kdown$K.TEMPS, bw =3)
  densM <- density (d.Mc$M.TEMPS, bw =3)
  if (max(densK$y) > max(densM$y)) {
    png (filename = paste (nomfichier,".KM10",".png", sep =""), width = 1500, height = 700)
    plot (density(d.Kdown$K.TEMPS, bw=10), lwd=2, col = "red", xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Appuis clavier/souris (val. absolue, bw = 10)"))
    points (density(d.Mc$M.TEMPS, bw=10), type ="l", lwd=2, lty = 2, col = "blue", main ="", xlab ="", ylab="")
    legend("topright", inset=.01, c("Clavier","Souris"),
           lwd=c(2,2), lty=c(1, 2), col=c("red", "blue"))
    dev.off()
  }
  else {
    png (filename = paste (nomfichier,".MK10",".png", sep =""), width = 1500, height = 700)
    plot (density(d.Mc$M.TEMPS, bw=10), lwd=2, col = "blue", lty= 2, xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Appuis clavier/souris (val. absolue, bw = 10)"))
    points (density(d.Kdown$K.TEMPS, bw=10), type ="l", lwd=2, col = "red", main ="", xlab ="", ylab="")
    legend("topright", inset=.01, c("Souris","Clavier"),
           lwd=c(2,2), lty=c(2, 1), col=c("blue", "red"))
    dev.off()
  }
}

if (exists("d.K", environment())) {
  Rez <- cbind (Rez,AnalyseClavier(d.K))
  d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
  png (filename = paste (nomfichier,"K10",".png", sep =""), width = 1500, height = 700)
  plot (density(d.Kdown$K.TEMPS, bw=10), xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Densité des appuis clavier (bw=10)"))
  dev.off()
  rm (d.K,envir = .GlobalEnv)
}
else {
  resultats <- data.frame(K.DuM=NA,K.NbTouches=NA,K.NbTouchesFreq=NA,K.NbAppuis=NA,
                          K.NbAppuisS=NA,K.TpMoyEntreAppuis=NA,K.TpSDEntreAppuis=NA,
                          K.TpMoyAppui=NA,K.TpSDAppui=NA)
  Rez <- cbind (Rez,resultats)
}

if (exists("d.M", environment())) {
  Rez <- cbind (Rez,AnalyseSouris(d.M))
  d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
  png (filename = paste (nomfichier,".M10",".png", sep =""), width = 1500, height = 700)
  plot (density(d.Mc$M.TEMPS, bw=10), xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Densité des appuis souris (bw=10)"))
  dev.off()                      
  rm (d.M, envir = .GlobalEnv)
}
else {
  resultats <- data.frame(M.DuM=NA,M.NbClics=NA,M.NbCliclsS=NA,
                          M.LR=NA,M.TpMoyEntreAppuis=NA,M.TpSDEntreAppuis=NA,M.Vit=NA)
  Rez <- cbind (Rez,resultats)
}

if (exists("d.P", environment())) {
  Rez <- cbind (Rez,AnalysePad(d.P))
  png (filename = paste (nomfichier,".P10",".png", sep =""), width = 800, height = 500)
  plot (density(PadRythmn$timecode, bw=10), xlab = "Temps (s)", ylab = "Nombre d'appuis", main = paste (nomfichier,"\n","Densité des appuis pad (bw=10)"))
  dev.off()
  rm (PadRythmn, d.P, envir = .GlobalEnv)
}
else {
  resultats <- data.frame(P.DuM=NA,P.NbTouches=NA,P.NbTouchesFreq=NA,P.NbAppuis=NA,
                          P.NbAppuisS=NA,P.TpMoyEntreAppuis=NA,P.TpSDEntreAppuis=NA,
                          P.TpMoyAppui=NA,P.TpSDAppui=NA,P.Vit=NA)
  Rez <- cbind (Rez,resultats)
}
write.csv(Rez, file = paste(nomfichier,".ok.csv", sep=""))
return (Rez)
}