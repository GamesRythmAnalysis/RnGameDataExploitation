# SORTIES GRAPHIQUES
# GRAPHIQUES CLAVIER SEUL

graphiques.clavier <- function (K.NbTouchesFreq,touchesfreq,d.Kdown,d.K,K.DuM,infobaz) {
  
  graphiques.density(d.Kdown,K.TEMPS,"red",
                     "Frequence des appuis clavier",infobaz,
                     paste (infobaz,".K10",".png", sep =""),
                     "Temps (s)","Appuis")

  # Decomposition densite par touches (sur touches freq.)
  # Pas plus de 9 touches freq. pour plage couleur
  if (K.NbTouchesFreq > 1) {
    
    ifelse (K.NbTouchesFreq < 10, 
            nomtouchesfreq <- rownames (touchesfreq)[1:K.NbTouchesFreq],
            nomtouchesfreq <- rownames (touchesfreq)[1:9])
    timingappui2 <- subset(d.Kdown, K.TOUCHE %in% nomtouchesfreq)
    
    # choisir des seuils de densite pour le binwidth de geom_area
    # le choix de K.DuM a l'air d'un bon compromis
    
    graphiques.stack(timingappui2,K.TEMPS,K.TOUCHE,K.DuM*3,
                     "Frequence des appuis clavier (touches frequentes) | binwidth variable",
                     infobaz,"Touche",paste (infobaz,".TCHVAR",".png", sep =""),
                     "Temps (s)","Appuis")
    
    # Visualisations : densite relative des appuis (touches les plus frequentes) sur la duree de la session
    
    
    viztouches <- as.data.frame(touchesfreq) 
    names(viztouches) <- c ("touche", "freq")
    viztouches <- subset(viztouches, touche %in% nomtouchesfreq)
    
    ggplot (data = viztouches, aes (area = freq, fill = touche, label = touche))+
      geom_treemap(linetype = 1, colour ="white", size =3) +
      scale_fill_brewer(palette = "Set1") +
      ggtitle (label = "Frequence des appuis clavier (touches frequentes)",
               subtitle = infobaz) +
      theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
      geom_treemap_text(grow = TRUE, reflow = TRUE) +
      guides (fill = FALSE)
    ggsave(filename = paste (infobaz,".TCHFREQ",".png", sep =""), width = 15, height = 15)
    
    keyboard_rythm <- lapply(levels(d.K$K.TOUCHE),GetKeyRythm)
    keyboard_rythm <- do.call("rbind",keyboard_rythm)
    
    durtouches <- keyboard_rythm %>%
      group_by(touche) %>%
      summarise(dureemoy = mean(duration)) %>%
      filter (touche %in% nomtouchesfreq)
    
    ggplot (data = durtouches, aes (area = dureemoy, fill = touche, label = touche))+
      geom_treemap(linetype = 1, colour ="white", size =3) +
      scale_fill_brewer(palette = "Set1") +
      ggtitle (label = "Duree moyenne d'appui sur les touches les plus frequentes",
               subtitle = infobaz) +
      theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
      geom_treemap_text(grow = TRUE, reflow = TRUE) +
      guides (fill = FALSE)
    ggsave(filename = paste (infobaz,".TCHDUR",".png", sep =""), width = 15, height = 15)
    
    totaldur <- keyboard_rythm %>%
      group_by(touche) %>%
      summarise(dureemoy = sum(duration)) %>%
      filter (touche %in% nomtouchesfreq)
    
    ggplot (data = totaldur, aes (area = dureemoy, fill = touche, label = touche))+
      geom_treemap(linetype = 1, colour ="white", size =3) +
      scale_fill_brewer(palette = "Set1") +
      ggtitle (label = "Duree totale d'appui sur les touches les plus frequentes",
               subtitle = infobaz) +
      theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
      geom_treemap_text(grow = TRUE, reflow = TRUE) +
      guides (fill = FALSE)
    ggsave(filename = paste (infobaz,".TCHDURTOT",".png", sep =""), width = 15, height = 15)
  }
}

  
