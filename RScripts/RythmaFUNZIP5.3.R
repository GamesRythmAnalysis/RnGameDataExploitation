## Rythmanalyse fonction v.5.3

# Debug
# debut <-0
# fin <- "max"
# nomfichier <- "2017.09.26.MT.NierAutomata.s3.zip"
# setwd("~/Documents/Projets R/Rythmanalyse")

#fonction de lecture des configs
config.read <- function(nomfichier){
  config<-read.csv2("DefaultConfig.csv")
  #on utilise deux fichier de config un par défault qui stocke toute les valeur par défaut et un autre qui contient les overrides
  if(file.exists("Config.csv")){
    conf<-read.csv2("Config.csv") #on utilise des vecteur pour etre compatible avec a peut pret tout
    for(nom in names(conf)){
      config[[nom]]<-conf[[nom]] #on réecris sur les valeurs
    }
  }
  return(config)
}

Rythmanalyse <- function (nomfichier, debut = 0, fin = "max"){ # type : "2014.02.16.MT.Doom.s1.zip"
  
  source("RScripts/ImportZip.1.2.R")
  source("RScripts/AnalyseSouris.1.5.R")
  source("RScripts/AnalyseClavier.1.4.R")
  source("RScripts/AnalysePad.1.6.R")
  source("RScripts/Recentrage.1.0.R")
  
  config<-config.read()
  
  setwd("Data")
  ImportZip (nomfichier, debut, fin)
  
  titre <- substr (nomfichier,15,nchar(nomfichier)-4)
  date <- substr (nomfichier,1,10)
  usr <- substr (nomfichier,12,13)
  infobaz <- paste (date,".",usr,".",titre,".(",debut,"-",fin,")",sep ="")
  Rez <- cbind (nomfichier,date,usr,titre) ## Attention a tout sortir au meme format pour traitement en masse
  
  #on creer un dossier par utilisateur/jeux 
  setwd("../")
  if(!dir.exists(paste("Resultat/",infobaz,sep = ""))){
    dir.create(paste("Resultat/",infobaz,sep = ""),recursive = T)
  }
  setwd(paste("Resultat/",infobaz,sep = ""))
  
  # Traitement pour Clavier seul  
  if (exists("d.K", environment())) {
    Rez <- cbind (Rez,AnalyseClavier(d.K,infobaz,config))
    d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
    densK <- density (d.Kdown$K.TEMPS, bw = 10)
    
    if(config$Graph & config$KeyboardGraph){
      png (filename = paste (infobaz,".K10",".png", sep =""), 
           width = 1500, height = 700)
      plot (densK, 
            xlab = "Temps (s)", ylab = "Nombre d'appuis", 
            col ="red", lwd = 3,
            main = paste (nomfichier,"\n","Densit des appuis clavier (bw=10)"))
      dev.off()
    }
    K<-TRUE
    rm (d.K,envir = .GlobalEnv)
  }
  else {
    K<-FALSE
    resultats <- data.frame(K.DuM=NA,K.NbTouches=NA,K.NbTouchesFreq=NA,
                            K.NbAppuis=NA,K.NbAppuisS=NA,
                            K.TpMoyEntreAppuis=NA,K.TpSDEntreAppuis=NA,
                            K.TpMoyAppui=NA,K.TpSDAppui=NA,
                            K.TpsAppui=NA,K.PropAct=NA,
                            K.ToucheFreq=NA,K.PropFreq=NA,
                            K.TpMoyAppuiFreq=NA,K.TpSDAppuiFreq=NA)
    Rez <- cbind (Rez,resultats)
  }
  
  # Traitement pour Souris seule  
  if (exists("d.M", environment())) {
    Rez <- cbind (Rez,AnalyseSouris(d.M,infobaz,config))
    d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
    densM <- density (d.Mc$M.TEMPS, bw = 10)
    
    if(config$Graph & config$MouseGraph){
      png (filename = paste (infobaz,".M10",".png", sep =""), width = 1500, height = 700)
      plot (densM, 
            xlab = "Temps (s)", ylab = "Nombre d'appuis", col ="blue", lwd = 3,
            main = paste (nomfichier,"\n","Densit des appuis souris (bw=10)"))
      dev.off()
    }
    M<-TRUE
    rm (d.M, envir = .GlobalEnv)
  }
  else {
    M<-FALSE
    resultats <- data.frame(M.DuM=NA,M.NbClics=NA,M.NbCliclsS=NA,
                            M.TpsClickR=NA,M.TpsClickL=NA,
                            M.TpsTotClick=NA,M.MoyTpsClickR=NA,
                            M.SDTpsClickR=NA,M.MoyTpsClickL=NA,M.SDTpsClickL=NA,
                            M.LR=NA,M.TpMoyEntreAppuis=NA,M.TpSDEntreAppuis=NA,
                            M.Vit=NA,M.VitTrueXY=NA)
    Rez <- cbind (Rez,resultats)
  }
  
  # Traitement pour Clavier ET Souris  
  if (M & K & config$Graph & config$MouseGraph & config$KeyboardGraph ) {
    yrange <- c (0,max (densM$y,densK$y))
    xrange <- c (min (d.Kdown$K.TEMPS,d.Mc$M.TEMPS),max (d.Kdown$K.TEMPS,d.Mc$M.TEMPS))
    png (filename = paste (infobaz,".KM10",".png", sep =""), width = 1500, height = 700)
    plot(x=xrange, y= yrange,
         type="n",
         xlab="Temps (s)",
         ylab="Densit des appuis",
         main = paste (nomfichier,"\n","Appuis clavier/souris (val. absolue, bw = 10)")
    )
    points (density(d.Kdown$K.TEMPS, bw=10), type ="l", lwd=3, col = "red")
    points (density(d.Mc$M.TEMPS, bw=10), type ="l", lwd=3, lty = 2, col = "blue")
    legend("topright", inset=.01, c("Clavier","Souris"),
           lwd=c(2,2), lty=c(1, 2), col=c("red", "blue"))
    dev.off()
  }

  # Traitement pour Pad  
  if (exists("d.P", environment())) {
    Rez <- cbind (Rez,AnalysePad(d.P,infobaz,config))
    
    # les plots se font dans la fonction
    rm (d.P, envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(P.DuM=NA,P.NbTouches=NA,P.NbTouchesFreq=NA,
                          P.NbAppuis=NA,P.NbAppuisS=NA,
                          P.TpMoyEntreAppuis=NA,P.TpSDEntreAppuis=NA, 
                          P.TpMoyAppui=NA,P.TpSDAppui=NA,
                          P.ToucheFreq=NA,P.PropFreq=NA,
                          P.TpMoyEntreAppuisFreq=NA,P.TpSDEntreAppuisFreq=NA, 
                          P.TpMoyAppuiFreq=NA,P.TpSDAppuiFreq=NA,
                          P.Vit=NA,P.VitG=NA,P.VitD=NA)
    Rez <- cbind (Rez,resultats)
  }
  write.csv(Rez, file = paste(infobaz,".ok.csv", sep=""))
  setwd("../../")
  return (Rez)
}
