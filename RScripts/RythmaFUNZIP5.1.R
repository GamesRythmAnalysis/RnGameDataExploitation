## Rythmanalyse fonction v.5.1

# Debug
# debut <-0
# fin <- "max"
# nomfichier <- "2017.09.26.MT.NierAutomata.s3.zip"
# setwd("~/Documents/Projets R/Rythmanalyse")

Rythmanalyse <- function (nomfichier, debut = 0, fin = "max"){ # type : "2014.02.16.MT.Doom.s1.zip"
  
  source("RScripts/ImportZip.1.2.R")
  source("RScripts/AnalyseSouris.1.3.R")
  source("RScripts/AnalyseClavier.1.3.R")
  source("RScripts/AnalysePad.1.6.R")
  
  setwd("Data")
  ImportZip (nomfichier, debut, fin)

  titre <- substr (nomfichier,15,nchar(nomfichier)-4)
  date <- substr (nomfichier,1,10)
  usr <- substr (nomfichier,12,13)
  infobaz <- paste (date,".",usr,".",titre,".(",debut,"-",fin,")",sep ="")
  Rez <- cbind (nomfichier,date,usr,titre) ## Attention à tout sortir au meme format pour traitement en masse

# Traitement pour Clavier ET Souris  
  if (exists("d.M", environment()) & exists ("d.K", environment())) {
    d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
    d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
    densK <- density (d.Kdown$K.TEMPS, bw = 10)
    densM <- density (d.Mc$M.TEMPS, bw = 10)
    yrange <- c (0,max (densM$y,densK$y))
    xrange <- c (min (d.Kdown$K.TEMPS,d.Mc$M.TEMPS),max (d.Kdown$K.TEMPS,d.Mc$M.TEMPS))
    png (filename = paste (infobaz,".KM10",".png", sep =""), width = 1500, height = 700)
    plot(x=xrange, y= yrange,
         type="n",
         xlab="Temps (s)",
         ylab="Densit des appuis",
         main = paste (nomfichier,"\n","Appuis clavier/souris (val. absolue, bw = 10)")
    )
    points (density(d.Kdown$K.TEMPS, bw=10), type ="l", lwd=3, col = "red")
    points (density(d.Mc$M.TEMPS, bw=10), type ="l", lwd=3, lty = 2, col = "blue")
    legend("topright", inset=.01, c("Clavier","Souris"),
           lwd=c(2,2), lty=c(1, 2), col=c("red", "blue"))
    dev.off()
  }

# Traitement pour Clavier seul  
  if (exists("d.K", environment())) {
    Rez <- cbind (Rez,AnalyseClavier(d.K,infobaz))
    d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
    png (filename = paste (infobaz,".K10",".png", sep =""), 
         width = 1500, height = 700)
    plot (density(d.Kdown$K.TEMPS, bw=10), 
          xlab = "Temps (s)", ylab = "Nombre d'appuis", 
          col ="red", lwd = 3,
          main = paste (nomfichier,"\n","Densit des appuis clavier (bw=10)"))
    dev.off()
    rm (d.K,envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(K.DuM=NA,K.NbTouches=NA,K.NbTouchesFreq=NA,
                          K.NbAppuis=NA,K.NbAppuisS=NA,
                          K.TpMoyEntreAppuis=NA,K.TpSDEntreAppuis=NA,
                          K.TpMoyAppui=NA,K.TpSDAppui=NA,
                          K.ToucheFreq=NA,K.PropFreq=NA,
                          K.TpMoyAppuiFreq=NA,K.TpSDAppuiFreq=NA)
    Rez <- cbind (Rez,resultats)
  }

# Traitement pour Souris seule  
  if (exists("d.M", environment())) {
    Rez <- cbind (Rez,AnalyseSouris(d.M,infobaz))
    d.Mc <- subset (d.M, M.EVENEMENT == "mouse 1 down" | M.EVENEMENT == "mouse 2 down")
    png (filename = paste (infobaz,".M10",".png", sep =""), width = 1500, height = 700)
    plot (density(d.Mc$M.TEMPS, bw=10), 
          xlab = "Temps (s)", ylab = "Nombre d'appuis", col ="blue", lwd = 3,
          main = paste (nomfichier,"\n","Densit des appuis souris (bw=10)"))
    dev.off()                      
    rm (d.M, envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(M.DuM=NA,M.NbClics=NA,M.NbCliclsS=NA,
                          M.LR=NA,M.TpMoyEntreAppuis=NA,M.TpSDEntreAppuis=NA,
                          M.Vit=NA,M.VitTrueXY=NA)
    Rez <- cbind (Rez,resultats)
  }

# Traitement pour Pad  
  if (exists("d.P", environment())) {
    Rez <- cbind (Rez,AnalysePad(d.P,infobaz))
    # les plots se font dans la fonction
    rm (d.P, envir = .GlobalEnv)
  }
  else {
    resultats <- data.frame(P.DuM=NA,P.NbTouches=NA,P.NbTouchesFreq=NA,
                          P.NbAppuis=NA,P.NbAppuisS=NA,
                          P.TpMoyEntreAppuis=NA,P.TpSDEntreAppuis=NA, 
                          P.TpMoyAppui=NA,P.TpSDAppui=NA,
                          P.ToucheFreq=NA,P.PropFreq=NA,
                          P.TpMoyEntreAppuisFreq=NA,P.TpSDEntreAppuisFreq=NA, 
                          P.TpMoyAppuiFreq=NA,P.TpSDAppuiFreq=NA,
                          P.Vit=NA,P.VitG=NA,P.VitD=NA)
    Rez <- cbind (Rez,resultats)
  }
  write.csv(Rez, file = paste(infobaz,".ok.csv", sep="",encoding="UTF-8"))
  setwd("../")
  return (Rez)
}
