# Analyse Clavier
# Fonction pour analyse du clavier Rythmanalyse

GetKeyRythm <- function(key){
  ## Un data frame vide pour recevoir les résultats
  results <- data.frame("down.time"=numeric(),"duration"=numeric(),"touche"=factor())
  down <- NULL
  ## On est obligé de passer par une boucle pour parser ligne par ligne
  for (i in 1:nrow(d.K)) {
    ## ignorer les lignes qui concernent une autre clé que la notre
    if (d.K[i,"K.TOUCHE"] != key) next
    ## Pour la bonne clé, si l'on rencontre un down, le stocker 
    ##(ainsi, si l'on rencontre deux down de suite, sans up entre les deux, 
    ##le premier sera effaéé et seul le second comptera)
    if (d.K$K.EVENEMENT[i] == "Key Down") {
      down <- d.K[i,]
      next
    }
    ## Si l'on rencontre un up
    if (d.K$K.EVENEMENT[i] == "Key Up") {
      ## vérifier si l'on a bien eu un down précédemment
      if (is.null(down)== FALSE) {
        ## Calculer la durée entre down et up
        duration <- d.K$K.TEMPS[i] - down$K.TEMPS
        down.time <- down$K.TEMPS
        ## créer une ligne de data frame avec nom de la clé, début du down, temps du down
        ligne <- c(down.time,duration)
        ## la concaténer avec les résultats précédents
        results <- rbind(results,ligne)
        ## vider le down (en cas de deux up consécutifs, au cas oé)
        down <- NULL}
      #if (is.null(down)== TRUE) { # Traiter erreur dans le cas oé on rencontre d'abord un Up (é négliger)
      else
      {
        duration <- NA
        down.time <- NA
        ligne <-c(down.time,duration)
        results <- rbind (results,ligne)
      }
    }
    
    ## ajouter une variable identifiant la clé pour fusion avec les résultats sur les autres clé
    results$touche <- key
    
  }
  names (results) <- c ("down.time","duration","touche")
  return(results)
}

AnalyseClavier <- function (d.K,infobaz) { #possibilite de repasser valfreq pour touches freq. en argument
  # Nombre appuis
  d.Kdown <- subset (d.K, K.EVENEMENT == "Key Down")
  K.NbAppuis <- length (d.Kdown$K.EVENEMENT)
  # Durée secondes, durée minutes activite clavier
  K.DuS <- max (d.K$K.TEMPS) - min (d.K$K.TEMPS)
  K.DuM <- K.DuS / 60
  # Nombre d'appuis par seconde
  K.NbAppuisS <- K.NbAppuis / K.DuS
  # Nombre de touches utilisées
  # sort(table(d.K$K.TOUCHE), decreasing = TRUE)
  K.NbTouches <- length(levels(d.K$K.TOUCHE))
  # Touches frequentes
  valfreq <- 0.01
  tabletouches <- sort(table(d.Kdown$K.TOUCHE),decreasing=TRUE)
  touchesfreq <- subset (tabletouches, tabletouches > K.NbAppuis * valfreq)
  K.NbTouchesFreq <- length (touchesfreq)
  
  # Visualisations : densité relative des appuis (touches les plus fréquentes) sur la durée de la session
  
  # Décomposition densité par touches (sur touches freq.)
  # Pas plus de 9 touches freq. pour plage couleur
  ifelse (K.NbTouchesFreq < 10, 
          nomtouchesfreq <- rownames (touchesfreq)[1:K.NbTouchesFreq],
          nomtouchesfreq <- rownames (touchesfreq)[1:9])
  timingappui2 <- subset(d.Kdown, K.TOUCHE %in% nomtouchesfreq)
  
  # choisir des seuils de densité pour le binwidth de geom_area
  # le choix de K.DuM a l'air d'un bon compromis
  # densite <- 200
  # if (K.DuM<15) {densite <- 15}
  
  ggplot(timingappui2, aes (K.TEMPS, fill = K.TOUCHE))+
    geom_area (stat="bin", binwidth = 200, position = "stack", linetype = 1, size = 0.8, colour ="black") +
    xlab ("Temps (s)") +
    ylab ("Appuis") +
    ggtitle (label = "Fréquence des appuis clavier (touches frequentes) | binwidth fixe",
             subtitle = infobaz) +
    scale_fill_brewer("Touche", palette="Set1")+
    theme_classic()
  ggsave(filename = paste (infobaz,".TCH",".png", sep =""), width = 15, height = 7)
  
  ggplot(timingappui2, aes (K.TEMPS, fill = K.TOUCHE))+
    geom_area (stat="bin", binwidth = K.DuM*3, position = "stack", linetype = 1, size = 0.8, colour ="black") +
    xlab ("Temps (s)") +
    ylab ("Appuis") +
    ggtitle (label = "Fréquence des appuis clavier (touches frequentes) | binwidth variable",
             subtitle = infobaz) +
    scale_fill_brewer("Touche", palette="Set1")+
    theme_classic()
  ggsave(filename = paste (infobaz,".TCHVAR",".png", sep =""), width = 15, height = 7)
  
  
  # Visualisations : répartition de la fréquence des appuis (touches les plus fréquentes)
  
  viztouches <- as.data.frame(touchesfreq) 
  names(viztouches) <- c ("touche", "freq")
  viztouches <- subset(viztouches, touche %in% nomtouchesfreq)
  
  ggplot (data = viztouches, aes (area = freq, fill = touche, label = touche))+
    geom_treemap(linetype = 1, colour ="white", size =3) +
    scale_fill_brewer(palette = "Set1") +
    ggtitle (label = "Fréquence des appuis clavier (touches frequentes)",
             subtitle = infobaz) +
    theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
    geom_treemap_text(grow = TRUE, reflow = TRUE) +
    guides (fill = FALSE)
  ggsave(filename = paste (infobaz,".TCHFREQ",".png", sep =""), width = 15, height = 15)
  
  
  # Temps entre appuis et ecart-type
  K.TpEntreAppuis <- d.Kdown$K.TEMPS[2:length(d.Kdown$K.TEMPS)]-d.Kdown$K.TEMPS[1:length(d.Kdown$K.TEMPS)-1]
  K.TpMoyEntreAppuis <- mean (K.TpEntreAppuis)
  K.TpSDEntreAppuis <- sd (K.TpEntreAppuis)
  # Durée des appuis
  keyboard_rythm <- lapply(levels(d.K$K.TOUCHE),GetKeyRythm)
  keyboard_rythm <- do.call("rbind",keyboard_rythm)
  K.TpMoyAppui <- mean (keyboard_rythm$duration, na.rm = TRUE) # Temps moyen d'un appui
  K.TpSDAppui <- sd (keyboard_rythm$duration, na.rm = TRUE) # Ecart-type temps d'un appui
  
  mostfreq <- subset (keyboard_rythm, keyboard_rythm$touche == names (touchesfreq[1])) # On ne conserve que la touche la plus fréquente
  K.ToucheFreq <- mostfreq$touche[1]
  K.PropFreq <- (nrow (mostfreq)/K.NbAppuis)*100
  K.TpMoyAppuiFreq <- mean (mostfreq$duration, na.rm = TRUE) # Temps moyen d'un appui
  K.TpSDAppuiFreq <- sd (mostfreq$duration, na.rm = TRUE) # Ecart-type temps d'un appui
  
# visualisations : treemap des durées moyennes et totales d'appui
    
  durtouches <- keyboard_rythm %>%
    group_by(touche) %>%
    summarise(dureemoy = mean(duration)) %>%
    filter (touche %in% nomtouchesfreq)
  
  ggplot (data = durtouches, aes (area = dureemoy, fill = touche, label = touche))+
    geom_treemap(linetype = 1, colour ="white", size =3) +
    scale_fill_brewer(palette = "Set1") +
    ggtitle (label = "Durée moyenne d'appui sur les touches les plus frequentes",
             subtitle = infobaz) +
    theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
    geom_treemap_text(grow = TRUE, reflow = TRUE) +
    guides (fill = FALSE)
  ggsave(filename = paste (infobaz,".TCHDUR",".png", sep =""), width = 15, height = 15)
  
  totaldur <- keyboard_rythm %>%
    group_by(touche) %>%
    summarise(dureemoy = sum(duration)) %>%
    filter (touche %in% nomtouchesfreq)
  
  ggplot (data = totaldur, aes (area = dureemoy, fill = touche, label = touche))+
    geom_treemap(linetype = 1, colour ="white", size =3) +
    scale_fill_brewer(palette = "Set1") +
    ggtitle (label = "Durée totale d'appui sur les touches les plus frequentes",
             subtitle = infobaz) +
    theme(plot.title = element_text(size = 20, face = "bold", hjust = 0)) +
    geom_treemap_text(grow = TRUE, reflow = TRUE) +
    guides (fill = FALSE)
  ggsave(filename = paste (infobaz,".TCHDURTOT",".png", sep =""), width = 15, height = 15)
    
  #K.NbAppuis # Nombre total d'appuis
  #K.DuM # Duree en minute de l'activite clavier
  #K.NbAppuisS # Appuis par seconde
  #K.NbTouches # Nombre de touches utilisees
  #K.NbTouchesFreq # Nombre de touches frequemment utilisées (enlever inf. à valfreq 1%)
  #K.TpMoyEntreAppuis # Temps moyen entre appuis  
  #K.TpSDEntreAppuis # Ecart-type
  #K.TpMoyAppui # Duree moyenne d'un appui
  #K.TpSDAppui # Ecart-type duree d'un appui
  # K.TpMoyAppuiFreq # Durée moyenne d'un appui sur touche la plus fréquente
  # K.TpSDAppuiFreq # Ecart-type durée d'un appui sur touche la plus fréquente
  
  resultats <- data.frame(K.DuM,K.NbTouches,K.NbTouchesFreq,
                          K.NbAppuis,K.NbAppuisS,
                          K.TpMoyEntreAppuis,K.TpSDEntreAppuis,
                          K.TpMoyAppui,K.TpSDAppui,
                          K.ToucheFreq,K.PropFreq,
                          K.TpMoyAppuiFreq,K.TpSDAppuiFreq)
  return (resultats)
}