---
title: "MR52 - Annexe: graphiques et données basé sur d'autre jeux de données"
output:
  pdf_document:
    toc_depth: 5
    toc: yes
    highlight: kate
  html_document:
    df_print: paged
    toc: yes
header-includes: 
  - \usepackage{subcaption}
  - \usepackage{fancyhdr}
  - \maxdeadcycles=200
  - \pagestyle{fancy}
  - \fancyhead[LO,LE]{MR52 - A2022}
  - \fancyhead[LE,RO]{OBRECHT Cyril}
---


```{r include = FALSE}

rm(list=ls())

packages <- c("ggplot2", "gridExtra","RColorBrewer","treemapify","dplyr","data.table","rstudioapi","ggpubr","knitr")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}

#chargement auto de tout les packages (evite q'un package manque a l'appel)
for(package in packages){
  library(package,character.only = T,warn.conflicts = F)
}

session <- list.files (path = "Data", pattern = ".zip") # Recuperer liste des fichiers .zip dans le repertoire de travail

source("RScripts/ImportScript.R")
import.script()


```

```{r include = FALSE}

get_center <- function(med,maxs){
  if(med == as.integer(names(maxs[1])) ){
    return(c(med,"both"))
  }
  
  test <- as.integer(names(maxs))<med
  max_left <- maxs[test]
  max_right <- maxs[!test]
  if(max_right[1] > maxs[as.character(med)] & max_left[1]>maxs[as.character(med)]){
    if(min(max_right[1],max_left[1])/maxs[1] > 0.8){
      # Si les deux pics sont de taille comparable alors on as un creux au niveaux médiane.
      # La valeur médianne est alors ce qui ce rapproche le plus du centre 
      return(c(med,"med: rivière"))
    } else {
      # Si les deux pics ne sont pas comparable alors il semble plus probable que l'un des pics soit issus d'un bruit et
      # que la valeur maximal soit le vrai centre.
      return(c(names(maxs[1]),"max: bruit"))
    }
  } else {
    # Toute les valeurs qui ce situe d'un coté de la médianne sont inférieure à la médianne.
    # Ceci signifie que le jeux force a toujours bouger dans la même direction. La méthode de la médianne n'est donc pas fiable dans ce cas de figure 
    return(c(names(maxs[1]),"max: pic"))
  }
  
}


get_centers <- function(data){
  
  maxs_x <- sort(table(data$M.XPOS), decreasing = TRUE)
  maxs_y <- sort(table(data$M.YPOS), decreasing = TRUE)
  
  if( # Les pics sont adjacents
    abs( as.integer(names(maxs_x[1])) - as.integer(names(maxs_x[2])) ) == 1 & 
    abs( as.integer(names(maxs_y[1])) - as.integer(names(maxs_y[2])) ) == 1
    ){
    # Les pics sont de taille comparable
    if ( maxs_x[2]/maxs_x[1] > 0.9 & maxs_y[2]/maxs_y[1] > 0.9 ){
      center_x = min(as.integer(names(maxs_x[1])),as.integer(names(maxs_x[2])))
      center_y = min(as.integer(names(maxs_y[1])),as.integer(names(maxs_y[2])))
      # Décalage des données pour compacter le centre sur 1 pixel
      
      data$M.XPOS[data$M.XPOS > center_x] <- data$M.XPOS[data$M.XPOS > center_x] - 1
      data$M.YPOS[data$M.YPOS > center_y] <- data$M.YPOS[data$M.YPOS > center_y] - 1
      
      return(c(center_x,center_y,"quad","quad",data))
      
    }
  }
  center_x <- get_center(median(data$M.XPOS),maxs_x)
  center_y <- get_center(median(data$M.YPOS),maxs_y)
  
  return(c(center_x[1],center_y[1],center_x[2],center_y[2],data))
  
}

filter_datasets <- function(dataset_name) {
  # on importe les donnees et dezippe les fichiers
  ImportZip (paste("Data",dataset_name,sep="/"), 0, "max")
  name <- substr(dataset_name,15,nchar(dataset_name)-4)
  d.M <- d.M[M.EVENEMENT == "mouse move",]
  
  cond1 <- fivenum(d.M$M.XPOS)[4] - fivenum(d.M$M.XPOS)[2]
  cond2 <- fivenum(d.M$M.YPOS)[4] - fivenum(d.M$M.YPOS)[2]
  if(cond1 < 20 & cond2 < 20){
    return(c(name,d.M))
  } else {
    return(NA)
  }
}

clean_data <- function(d.M){
  
  name <-d.M[[1]]
  d.M <- data.frame(d.M[-1])
  
  is_duplcate <- duplicated(rleid(d.M$M.XPOS,d.M$M.YPOS))
  to_remove <- which(is_duplcate)
  to_remove <- to_remove[is_duplcate[to_remove+1]]
  # If a duplicated value is at the end of the list it produce a NA
  to_remove <- to_remove[!is.na(to_remove)]
  
  d.M <- d.M[-to_remove,]
  centers <- get_centers(d.M)
  
  center_x <- as.integer(centers[1])
  center_y <- as.integer(centers[2])
  
  d.M <-  data.frame(centers[c(-1,-2,-3,-4)])
  
  d.M$M.DISTANCE <- sqrt(
    (d.M$M.XPOS - center_x) ^ 2 +
    (d.M$M.YPOS - center_y) ^ 2
  )
  
  d.M <- data.table(d.M[d.M$M.DISTANCE < quantile(d.M$M.DISTANCE,.85),])
  
  return(c(name,centers[3],centers[4],d.M))
}

make_graph <- function(d.M) {
  name <-d.M[[1]]
  
  meth_x <- d.M[[2]]
  meth_y <- d.M[[3]]
  
  d.M <- data.frame(d.M[c(-1,-2,-3)])
  
  info_x <- summary(d.M$M.XPOS)
  info_y <- summary(d.M$M.YPOS)
  
  
  centers <- get_centers(d.M)
  
  center_x <- centers[1]
  center_y <- centers[2]
  
  d.M <-  data.frame(centers[c(-1,-2,-3,-4)])

  select_x <- "1er-3ème quartile"
  select_y <- "1er-3ème quartile"
  
  if(info_x[5] - info_x[2] < 7){
    info_x[5] <- info_x[3] + 3
    info_x[2] <- info_x[3] - 3
    select_x <- "médiane +/- 3"
  }
  
  sub_x <- d.M[d.M$M.XPOS >= info_x[2] & d.M$M.XPOS <= info_x[5],]
  sub_x$isCenter <- sub_x$M.XPOS==center_x
  
  if(info_y[5] - info_y[2] < 7){
    info_y[5] <- info_y[3] + 3
    info_y[2] <- info_y[3] - 3
    select_y <- "médiane +/- 3"
  }
  
  sub_y <- d.M[d.M$M.YPOS >= info_y[2] & d.M$M.YPOS <= info_y[5],]
  sub_y$isCenter <- sub_y$M.YPOS==center_y

  histo_x <- ggplot(sub_x,aes(x = M.XPOS,fill= isCenter)) +
    geom_histogram(binwidth = 1) +
    ggtitle(paste("Histograme des valeurs de X comprise\nentre ",select_x," (",meth_x,")",sep=""))+
    scale_x_continuous(breaks = seq(min(sub_x$M.XPOS),max(sub_x$M.XPOS)))+ 
    theme(axis.text.x = element_text(angle = 45,  hjust=1))

  histo_y <- ggplot(sub_y,aes(x = M.YPOS,fill= isCenter)) +
    geom_histogram(binwidth = 1) +
    ggtitle(paste("Histograme des valeurs de Y comprise\nentre ",select_y," (",meth_y,")",sep=""))+
    scale_x_continuous(breaks = seq(min(sub_y$M.YPOS),max(sub_y$M.YPOS)))+ 
    theme(axis.text.x = element_text(angle = 45,  hjust=1))
  

  return(annotate_figure(ggarrange(histo_x,histo_y),top = paste(name,": ",round(max(d.M$M.TEMPS)/60,2), "min",sep = "")))
  
}
```
```{r include = FALSE}
datas <- lapply(session, filter_datasets)

datas <- datas[!is.na(datas)]

names <- unlist(lapply(datas, `[[`, 1))

datas <- lapply(datas, clean_data)

graphs <- lapply(datas, make_graph)

```

```{r histograms, echo=FALSE, dev='pdf', fig.show='hide'}
# fig.height=4,fig.width=9,
for( p in graphs){
  print(p)
}
```
\clearpage
\newpage
```{r, echo=FALSE, out.height="40%", fig.cap=names}
include_graphics(fig_chunk(label = "histograms", ext = "pdf", number = 1:length(graphs)))
```

```{r}
cadran <- function(data,nb.cadran=8){
  cadrans <- nb.cadran:1
  name <-data[[1]]
  
  meth_x <- data[[2]]
  meth_y <- data[[3]]
  
  data <- data.frame(data[c(-1,-2,-3)])
  
  x<- data$M.XPOS
  y<- data$M.YPOS
  
  centers <- get_centers(data)
  
  cx <- as.integer(centers[1])
  cy <- as.integer(centers[2])
  
  coords <- (x-cx) +1i*(y-cy)
  
  coords <- coords[coords != 0]
  
  coords <- Arg(coords)
  coords[coords<pi/nb.cadran] <- coords[coords<pi/nb.cadran] + 2*pi # de -pi;pi a pi/nb.cadran;2pi+pi/nb.cadran
  
  output <- factor(length(x),levels = cadrans)
  lapply(cadrans,function(c){
    output[coords <= 2*pi*c/nb.cadran + pi/nb.cadran] <<- c
  })
  
  polar <- data.frame(cadrans = output)

  return(
    ggplot(polar, aes(x = cadrans,color="dummy")) +
      coord_polar(direction=1,start= pi/2 - pi/nb.cadran)+
      geom_bar(width = 1)+ 
      xlab("")+
      ylab("")+
      theme(legend.position = "none" , axis.text.y = element_blank() , axis.ticks = element_blank())+
      scale_color_manual(values=c("#000000"))+
      ggtitle(paste("Polar: ",name," (",cx,",",cy,")",sep=""))
  )
}

graphs <- lapply(datas, cadran)
```

```{r polars, echo=FALSE, fig.height=3, fig.asp=1,dev='pdf', fig.show='hide'}
for( i in 1:length(graphs)){
  print(graphs[[i]])
}
```
\clearpage
\newpage
```{r, echo=FALSE, results='asis'}
# [width=0.4\\linewidth]
for(i in seq(1,length(graphs),2)){
  fig_1 = paste0(
    "\\begin{subfigure}{.5\\textwidth}\n",
    "\\includegraphics{", fig_chunk(label = "polars", ext = "pdf", number = i) ,"}\n",
    "\\caption{", names[i], "}\n",
    "\\end{subfigure}%\n"
  )
  fig_2 = paste0(
    "\\begin{subfigure}{.5\\textwidth}\n",
    "\\includegraphics{", fig_chunk(label = "polars", ext = "pdf", number = (i + 1)) ,"}\n",
    "\\caption{", names[i + 1], "}\n",
    "\\end{subfigure}%\n"
  )
  cat(paste0(
    "\\begin{figure}\n",
    fig_1,
    fig_2,
    "\\end{figure}\n"
  ))
}
```