#=# Fichier pour les benchmaks : test de rapidité des calculs

## Setup des script

rm(list=ls()) # on vide la memoire de RStudio
setwd("~/Documents/Projets R/RnGameDataExploitation-modularite") #choix du dossier ou se trouve le script Rythma

# Installation (si besoin) et chargement des packages requis
packages <- c("ggplot2", "gridExtra","RColorBrewer","treemapify","dplyr","microbenchmark")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))  
}

# chargement auto de tout les packages (evite q'un package manque a l'appel)
for(package in packages){
  library(package,character.only = T,warn.conflicts = F)
} 

source("RScripts/RythmaFUNZIP5.4.R") #charge la fonction d'analyse

## Setup du benchmark

# Dossier ou sont les données pour le benchmark
BENCHDIR <- "Benchmark"
benchFiles <- list.files(path = BENCHDIR,pattern = ".zip")
l <- length(benchFiles)

# chargement d'une sauvegarde si elle existe sinon création d'un substitu
if (file.exists("benchmark.csv")){
  
  benchData <- read.csv2("benchmark.csv")
  print("Les test suivant ont été importé, vous pouvez les override en re créant un test avec le même nom")
  print(levels(benchData$Name))
} else{
  
  benchSave <- data.frame("Name"=factor(),"File"=factor(),"min"=numeric(),"mean"=numeric(),"max"=numeric(),"sd"=numeric())
}

# Choix du nom du test
testName <- readline( prompt = "nom du test :")

# Benchmark
bench <- NULL
for (i in 1:l){
  bench <- rbind(bench,microbenchmark(Rythmanalyse(benchFiles[i],graph = FALSE,data.dir=BENCHDIR)))
  levels(bench$expr)[i]<-benchFiles[i]
}

# agrégation des données pour une forme plus facilement sauvegardable
benchData <- data.frame("Name"=factor(testName),"File"=factor(benchFiles),"min"=numeric(l),"mean"=numeric(l),"max"=numeric(l),"sd"=numeric(l))

for (i in 1:l){
  sub <- subset(bench,expr == levels(bench$expr)[i])
  sub$time <- sub$time / 1000000
  benchData$min[i] <- min(sub$time)
  benchData$mean[i] <- mean(sub$time)
  benchData$max[i] <- max(sub$time)
  benchData$sd[i] <- sd(sub$time)
}

# on suprime l'ancien test portant le même nom s'il existe après que tout ce soit bien passer puis on écrit
benchSave <- benchSave[benchSave$Name == testName,]
benchSave <- rbind(benchSave,benchData)

write.csv2(benchSave,"benchmark.csv")
